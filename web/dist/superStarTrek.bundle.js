!function(e){var t={};function i(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(n,a,function(t){return e[t]}.bind(null,a));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=5)}([function(e,t,i){"use strict";t.a=function(e){const t=["error","warn","log"],i="warn";function n(){window.onerror=function(t,i,n,a,s){switch(e){case"error":throw console.error(t,i,n,a,s),s;case"log":console.log(t,i,n,a,s);break;case"warn":default:console.error(t,i,n,a,s)}!function(e){switch(e){case e instanceof EvalError:console.error("stop using eval you fuck");break;case e instanceof InternalError:console.error("looks like some JS code you made fucked up");break;default:console.error("I couldn't even figure what error type that was so no snarky comment for you, sir!")}}(s)}}return{register:n,init:function(){t.includes(e)||(console.error("logLevel must be one of the following : ",t,". Setting logLevel to ",i),e=i),n()}}}},function(e,t,i){"use strict";new(i(0).a)("error").init(),t.a=function(){function e(e){let t={};return e.serializeArray().forEach(e=>{t[e.name]=e.value}),t}function t(){window.location.href=window.location.origin}function i(e){let t=$("#sign-up");t.find("input").each((function(e,t){$(t).val("")})),t.modal("show"),t.find("#submit").off("click").on("click",a)}function n(e){let t=$("#login");t.find("input").each((function(e,t){$(t).val("")})),t.modal("show"),t.find("#login-btn").off("click").on("click",s)}function a(i){let n=$("#sign-up").find("form"),a=e(n),s=$("#submit-btn");s.addClass("loading"),n.find(".error.message").transition("hide"),fetch("/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>{if(!e.ok)throw e;t()}).catch((async function(e){console.error(e),n.find(".error.message").transition("show")})).then(()=>s.removeClass("loading"))}function s(i){let n=$("#login").find("form"),a=e(n),s=$("#login-btn");s.addClass("loading"),n.find(".error.message").transition("hide"),fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>{if(!e.ok)throw e;t()}).catch(e=>{console.error(e),n.find(".error.message").transition("show")}).then(()=>s.removeClass("loading"))}function r(e){let i=$("#logout-btn");i.addClass("loading"),fetch("/logout",{method:"POST"}).then(e=>(console.log(e),e)).then(e=>{if(!e.ok)throw e;t()}).catch(e=>{console.error(e)}).then(()=>i.removeClass("loading"))}function o(e){e.stopPropagation(),this.value!==$("#sign-up input[name='password']").val()?$(this).closest(".field").addClass("error"):$(this).closest(".field").removeClass("error"),function(e){let t=$("#sign-up");e?t.find("#submit").removeClass("disabled"):t.find("#submit").addClass("disabled")}(function(){let e=$("#sign-up input[name='password']").val(),t=$("#sign-up input[name='confirm-password']").val();if(e!==t)return!1;return!0}())}function h(e){$(this).toggleClass("slash");let t=$(this).siblings("input");"password"===t.attr("type")?t.attr("type","text"):t.attr("type","password")}return{init:function(){!function(){let e=$("#sign-up");$("#sign-up-btn").on("click",i),$("#login-btn").on("click",n),$("#logout-btn").on("click",r),e.find("input[name='confirm-password']").on("input",o),$(".eye.slash").on("click",h),$(".message .close").off().on("click",(function(e){e.stopPropagation(),$(this).closest(".message").transition("fade")}))}()}}}},,,function(e,t){
/**
 * @file   : ptty.jquery.js
 * @ver    : 0.0.5 (beta)
 * @author : Pachanka <social@pachanka.org>
 * @url    : http://goto.pachanka.org/ptty/docs
 * @desc   : Ptty (Pseudo teletype). A terminal emulator plugin for jQuery.
 * @license: WTFPL Version 2. (http://www.wtfpl.net/)
 **/
!function(e){"use strict";e.fn.Ptty=function(t){var i={};return this.each((function(){var n=e(this),a={};window.commands=a;var s={},r={},o={},h={},l=[],c={ps:null,in:null,out:null,last:null,next:null,data:null},m=function(e){Object.getOwnPropertyNames(s);var t=!1,i=!1;return Object.entries(s).forEach(([n,a])=>{!t&&a.test(e)&&(i=n,t=!0)}),t?i:e},d=e.extend(!0,{ajax_options:{url:window.location.pathname,type:"POST"},param:"cmd",ps:"$",caret:"▮",caret_blink:800,native_css:!0,theme:"boring",native_cmds:!0,autocomplete:!0,history_max:800,autofocus:!0,before_cmd:!1,after_cmd:!1,i18n:{welcome:"Ptty (0.0.5 beta).<br> Type <b>help</b> to list the available commands.",error_not_found:"Command not found.",error_bad_method:"Invalid command method.",error_ajax:"Server error."}},t);i.get_terminal=function(e){return e?n.find(e):n},i.native_style=function(t,i){var n=t.attr("id");if(n=n?"#"+n:"."+t.attr("class").split(" ")[1],"boring"===i){var a=['.boring, .boring .prompt, .boring .content{ font-family: "Courier New", Courier, monospace; background-color: #111; color: #ddd; }',".boring .content{ padding: 15px 15px 0 15px; }",".boring .prompt{ padding: 0 15px 15px 15px; }",'.boring .loading span::after{content: "⚙"; color: #ddd; font-size: 10em; border-radius: 10em; opacity: 0.4;}',".boring .content ul{ margin: 0; }",".boring .prompt .input.show-caret{ color: #ddd; opacity: .85; }",".boring .prompt .input, .boring .prompt .input::before, .boring .prompt .input::after{ color: transparent; text-shadow:0 0 0 #ddd; }",".boring .content div .cmd_in .cmd_ps, .boring .prompt .input::before{ padding-right: 10px; }",".boring .content ul li{ list-style-type: none; }",".boring div.prompt div.input::after{ font-size: 2em; }",".boring div.prompt div.input, .boring div.content div div.cmd_in, .boring div.prompt div.input::before{ line-height: 2em; }"];a=a.join("\n"),e('<style id="ptty-boring-theme">'+a+"</style>").appendTo("head")}var s=[n+"div.content div p{ margin: 0; }","div.content div{ clear: both; white-space:pre-wrap; word-wrap:break-word; }","div.content div ul{ padding: 0; white-space: normal }","div.content div ul li{ list-style: none; }","div.content div ul.sq-li li{ display: inline-block; text-align: center; padding: 10px; min-width: 5%; }","div.prompt div.input{ width: 100%; white-space:pre-wrap; word-wrap:break-word; cursor: default; outline: none;}","div.prompt div.input::before{ vertical-align: middle; content: attr(data-ps); }","div.prompt div.input::after{ visibility : visible; vertical-align: middle; content: attr(data-caret); margin-left:-0.15em;}","div.prompt div.input.blink::after{ visibility : hidden; }","div.prompt .hide{ position:absolute; top: -9999em; }","div.loading{ display: none; }","div.loading.working{ display: block; display:flex; justify-content: center; align-items: center;position: fixed;  width: inherit; height: inherit; }","div.loading span{ -webkit-animation: spin 4s linear infinite; -moz-animation: spin 4s linear infinite; -ms-animation: spin 4s linear infinite; -o-animation: spin 4s linear infinite; animation: spin 4s linear infinite; }"];s=s.join("\n "+n+" "),e('<style id="ptty-styles">'+(s+="@-moz-keyframes spin { 100% { -moz-transform: rotate(360deg); } }@-webkit-keyframes spin { 100% { -webkit-transform: rotate(360deg); } }@-ms-keyframes spin { 100% { -ms-transform: rotate(360deg); } }@-o-keyframes spin { 100% { -o-transform: rotate(360deg); } }@keyframes spin { 100% { transform: rotate(360deg); } }")+"</style>").appendTo("head")},i.native_commands=function(){i.register("command",{name:"clear",method:function(e){return e.last="",e.out="",e},options:[],help:"Cleans the screen leaving a new command prompt ready."}),i.register("callback",{name:"clear",method:function(e){return n.find(".content").html(""),e}}),i.register("command",{name:"history",method:function(e){if(e.hasOwnProperty("clear"))l=[],e.out="History cleared.";else if(l.length>0){e.out="<ul>";for(var t=0;t<l.length;t+=1)e.out+="<li>"+l[t]+"</li>";e.out+="</ul>"}return e},options:["clear"],help:"Shows list of typed in commands. Type <i>history clear</i> to clear your history."}),i.register("command",{name:"help",method:function(e){var t=Object.keys(a);if("string"==typeof e[1]&&e[1].length>0)if(e.hasOwnProperty("-a")||e.hasOwnProperty("--all")){e.out="<b>Available commands:</b></br></br><ul>";for(var i=0;i<t.length;i+=1)e.out+="<li><p><b>"+i+"</b> - ",e.out+=a[t[i]].help+"</p></br></li>";e.out+="</ul>\n"}else void 0!==a[e[1]]?(e.out="<b>"+e[1]+"</b> - ",""!==a[e[1]].help?e.out+=a[e[1]].help+"\n":e.out+="No help entry available.\n"):e.out='help: The "'+e[1]+'" option does not exist.\n';else{e.out='Use "help [comand name]" to display specific info about a command.</br>\n',e.out+='Available commands are:</br><ul class="sq-li">';for(i=0;i<t.length;i+=1)e.out+="<li>"+t[i]+"</li>";e.out+="</ul>\n"}return e},options:[1,"-a","--all"],help:"Displays a list of useful information. Usage: <i>help command-name</i> to show <i>command-name</i>'s help.<i>help -a</i> or <i>help --all</i> to display all help."})},i.native_responses=function(e){for(var t in e)e.hasOwnProperty(t)&&i.register("response",{name:t,method:function(i){return e[t]=i[t],i}})},i.run_command=function(e,t=!1){O=t,x(e)},i.echo=function(e,t){e&&n.find(".content").append('<div><div class="cmd_out">'+e+"</div></div>"),t||L()},i.prompt=function(e,t){this.register("command",{name:"ask",method:e=>{let i=this.get_input();this.unregister("command","ask"),setTimeout(()=>t(i),10)},regex:new RegExp("[sS]*","i")})},i.type=function(t,i=60){this.echo("\n");this.get_terminal(".prompt");var n,a=e("<span></span>").appendTo(".content"),s=this,r=0;!function e(){n=t.slice(0,++r),a.html(n),s.echo();n.slice(-1);setTimeout(e,i)}()},i.format_grid=function(e,t=!0,i=null){var n=e.reduce((e,t)=>{var i=t.reduce((e,t)=>e>t.length?e:t.length,0);return e>i?e:i},0);return null===i&&(i=n),e.map(e=>e.map(e=>t?e.padStart(i):e.padEnd(i)))},i.print_grid=function(e,t=" ",i="\n",n=!1){for(var a=[],s=0;s<e.length;s++){var r=e[s].join(t);a.push(r+"\n")}var o=a.join(i);return n&&this.echo(o),o},i.change_settings=function(t){e.extend(!0,d,t)},i.get_settings=function(){return d},i.unregister=function(e,t){var i=!1;return"object"==typeof t&&t.hasOwnProperty("name")&&(t=t.name),"callbefore"==e&&h.hasOwnProperty(t)?(i=!0,delete h[t]):"command"==e&&a.hasOwnProperty(t)?(i=!0,delete a[t],delete s[t]):"response"==e&&r.hasOwnProperty(t)?(i=!0,delete r[t]):"callback"==e&&o.hasOwnProperty(t)&&(i=!0,delete o[t]),i},i.get_input=function(){return y.text()},i.register=function(e,t){var i=!1;if(t){var n=!!t.hasOwnProperty("name")&&t.name,l=!!t.hasOwnProperty("method")&&t.method,c=t.hasOwnProperty("options")?t.options:[],m=t.hasOwnProperty("help")?t.help:"",d=t.hasOwnProperty("regex")?t.regex:new RegExp(`^${n}$`);s[n]=d,"callbefore"==e&&"function"==typeof l?(h[n]=l,i=!0):"command"!=e||"string"!=typeof l&&"function"!=typeof l?"response"==e&&"function"==typeof l?(r[n]=l,i=!0):"callback"==e&&"function"==typeof l&&(o[n]=l,i=!0):(a[n]={help:m,options:c,exe:l},i=!0)}return i},i.set_command_option=function(t){return e.extend(!0,c,t)},i.get_command_option=function(e){var t;if("string"==typeof e)t=!!c.hasOwnProperty(e)&&c[e];else if("object"==typeof e){t={};for(var i=e.length-1;i>=0;i--)void 0!==c[e[i]]&&(t[e[i]]=c[e[i]])}else t=c;return t},i.tokenize=function(t,i){var n={},a=m(t);if(void 0===a[0]||""===a[0])n=!1;else if(void 0!==i){var s=!1,r=!1,o=!1,h=!1,l=!1,c=!1,d=!1,u=i.filter((function(e){if("number"==typeof e&&e>0&&void 0!==a[e])return n[e]=a[e],e}));i=e(i).not(u).get();for(var p=0;p<a.length;p++)l=a[p].charAt(0),c=a[p].slice(-1),d=a[p].charAt(a[p].length-2),e.inArray(a[p],i)>=0?(s=a[p],r=!1):'"'==l&&!1===h&&'"'!==c?(o='"',h=!0,r=a[p]):"'"==l&&!1===h&&"'"!==c?(o="'",h=!0,r=a[p]):c==o&&!0===h&&d+c!=="\\"+o?(h=!1,r+=" "+a[p],r=e.trim(r.substring(1).slice(0,-1).replace(/\\(.)/gm,"$1"))):!0===h?r+=" "+a[p]:r="'"==l&&"'"==c||'"'==l&&'"'==c?e.trim(a[p].substring(1).slice(0,-1)):a[p],s&&!1===h&&(n[s]=r)}else n[a[0]]=a;return n},n.html("");var u=null,p=null,g={};n.append('<div class="loading"><span></span></div><div class="content"><div>'+d.i18n.welcome+'</div></div><div class="prompt"><div class="input" contenteditable spellcheck="false" data-caret="'+d.caret+'" data-ps="'+d.ps+'"></div></div>');var y=n.find(".prompt .input"),f=n.find(".content"),b=n.find(".loading");n.attr("data-theme",d.theme).addClass(d.theme),d.native_css&&i.native_style(n,d.theme);var w=d.autofocus,v=d.autocomplete,S=d.history_max;d.autofocus&&y.focus(),n.bind("focus click",(function(){var e="";void 0!==window.getSelection?e=window.getSelection().toString():void 0!==document.selection&&"Text"==document.selection.type&&(e=document.selection.createRange().text),""==e&&j()})),y.click((function(){j()})),y.bind("blur",(function(){w=!1})),d.caret_blink>0&&setInterval((function(){d.caret_blink>0&&!0===w&&y.toggleClass("blink")}),d.caret_blink),d.native_cmds&&i.native_commands(),i.native_responses(c);var O=null,x=function(t){var n;if(b.addClass("working"),n=void 0!==t?t:y.text(),v=d.autocomplete,S=d.history_max,c.last=n,"string"==typeof c.next&&(n=c.next.replace(/%cmd%/i,n),c.next=null,S=0),!n||""==n)return T();if(p=m(n),void 0===a[p])return O||(c.out=p+" : "+d.i18n.error_not_found),T();if(g=i.tokenize(n,a[p].options),"function"==typeof d.before_cmd&&!(g=k(d.before_cmd(g))))return T();if("function"==typeof h[p]&&!(g=k(h[p](g))))return T();if(O||E(c.last),"function"==typeof a[p].exe)return k(a[p].exe(g)),T();if("string"!=typeof a[p].exe)return c.out=d.i18n.error_bad_method,T();var s={};if(!d.ajax_options.data){var r={};r[d.param]=null!==c.in?c.in:p,r[d.param+"_data"]=null!==c.data?c.data:g,s.data=r}var o=e.extend(!0,s,d.ajax_options);a[p].exe&&(o.url=a[p].exe);var l=e.ajax(o);l.done((function(e){g=k(e)})),l.fail((function(e,t,i){c.out=d.i18n.error_ajax})),l.always((function(e,t,i){return T()}))},k=function(t){if("object"==typeof t)for(var i in t)r.hasOwnProperty(i)&&e.extend(!0,c,r[i](t));return t},T=function(){v=d.autocomplete,S=d.history_max;var e=c.ps?c.ps:d.ps,t=c.out?c.out:"",i=c.in?c.in:"",a=c.last?c.last:"",s=c.next?c.next:null;O?f.append('<div><div class="cmd_out">'+t+"</div></div>"):f.append('<div><div class="cmd_in"><span class="cmd_ps">'+y.attr("data-ps")+"</span>"+a+'</div><div class="cmd_out">'+t+"</div></div>"),g&&(o.hasOwnProperty(p)&&k(o[p](g)),"function"==typeof d.after_cmd&&k(d.after_cmd(g))),y.attr("data-caret",d.caret).attr("data-ps",e).text(i),0===d.caret_blink&&y.removeClass("blink"),y.hasClass("show-caret")&&y.removeClass("show-caret"),n.hasClass(d.theme)||n.removeClass(n.attr("data-theme")).addClass(d.theme).attr("data-theme",d.theme),s&&(v=!1,S=0),O=null,g=c={ps:null,in:null,out:null,last:null,next:s,data:null},C()},C=function(){L(),j(),b.removeClass("working")},E=function(t){void 0!==a[p]&&""!==t&&S>0&&(l.length>d.history_entries&&l.shift(),l.push(e.trim(t))),u=0},L=function(){n.scrollTop(n.height()+1e17)},j=function(){if(y.focus(),w=!0,void 0!==window.getSelection&&void 0!==document.createRange){var e=document.createRange();e.selectNodeContents(y.get(0)),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(void 0!==document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(y.get(0)),i.collapse(!1),i.select()}};y.keydown((function(t){switch(t.keyCode){case 9:t.preventDefault(),v&&(!function(e){var t=[];if(e.match(/^[^\s]{0,}$/)){for(var i in a)""==e?t.push(i):0==i.indexOf(e)&&t.push(i);t.length>1?(c.out="<ul><li>"+t.join("</li><li>")+"</li></ul>",c.in=e,T()):1==t.length&&y.text(t.pop()+" ")}}(e.trim(y.text())),C());break;case 37:case 39:d.caret_blink>0&&(w=!1,y.addClass("blink show-caret"));break;case 38:t.preventDefault(),S>0&&(u=null===u||0==u?l.length-1:u-1,y.text(l[u]),C());break;case 40:if(t.preventDefault(),S>0){if(null===u||u==l.length-1){y.html("");break}u++,y.text(l[u]),C()}break;case 46:case 8:1!==y.text().length&&window.getSelection().toString()!=y.text()||y.html("");break;case 13:t.preventDefault(),document.execCommand("insertHTML",!1,""),x();break;case 27:c={ps:null,in:null,out:null,last:null,next:null,data:null},y.text(""),x()}}))})),i}}(jQuery)},function(e,t,i){"use strict";i.r(t);var n=i(0),a=i(1);i(4);const s=1;class r{constructor(){this.apiUrl="/games/superStarTrek"}createGameLog(e,t,i=s){return $.ajax({url:"/gameLog",data:JSON.stringify({score:e,victory:t,gameId:i}),contentType:"application/json",method:"POST"})}getHelp(e){return $.ajax({url:`${this.apiUrl}/help`,data:{command:e}})}}class o{constructor(e=!0){this.$el=null,this.$terminal=null,this._out="",this.silent=!1,this._command=null,this._input=null,this._argumentStr=null,this._arguments=null,this.questionMode=!1,this.question="",this.commands=[],window.terminal=this,this.paging=!0,this.takesInput=e}hideInput(){this.$el.find(".prompt").hide()}init(e,t){this.$el=e,this.$terminal=this.$el.Ptty({ps:"",autocomplete:!0,theme:t,i18n:{welcome:"-SUPER- STAR TREK\n\n",error_not_found:"Command not recognized, try 'help'.",error_bad_methdo:"Command malformed. Try 'help'."}}),this.takesInput||this.hideInput()}setPrompt(e){this.$terminal.change_settings({ps:e}),this.$terminal.run_command(),this.$el.find(".content > div").last().remove()}echo(e){this.silent||(this._out+=e)}newLine(){this.silent||(this._out+="\n")}printLine(e=""){this.silent||(this._out+=e+"\n")}skipLine(e=1){if(!this.silent)for(let t=0;t<e;t++)this._out+="\n"}getOutput(){return this._out}clear(){this.silent||(this._out="")}clearAll(){this.$el.find(".content").empty(),this._out=""}print(){this.silent||this._out&&(this.$terminal.echo(this._out),this._out="")}registerCommand(e){this.commands.find(t=>e.name===t.name)||(this.commands.push(e),this.$terminal.register("command",{name:e.name,method:t=>this.runCommand(e.name,t),regex:e.regex}))}unregisterCommand(e){let t=this.commands.findIndex(t=>e.name===t.name);-1!==t&&(this.commands.splice(t,1),this.$terminal.unregister("command",e.name))}parseCommand(e,t){let i=this.$terminal.get_input(),n=i.replace(t.regex,"");this._command=t,this._input=i,this._argumentStr=n,this._arguments=n.split(/\s/).filter(e=>e.length>0)}getArguments(){return this._arguments}hasOption(e){return e.test(this._argumentStr)}async runCommand(e,t){let i=this.commands.find(t=>t.name===e);if(!i)return t.out="Not recognized.",t;this.parseCommand(t,i);try{this.resolveUserCommand({command:i})}catch(e){console.error(e),this.printLine("OOOF, that went really wrong. Try that again."),this.print()}}runUserCommand(){return new Promise((e,t)=>{this.resolveUserCommand=e})}async ask(e){this.print();let t=this.$terminal.get_settings().ps;return this.setPrompt(e),new Promise((e,i)=>{this.answer=i=>{let n=this.$terminal.get_input();return this.$terminal.unregister("command","answer"),this.$terminal.change_settings({ps:t}),this.$terminal.set_command_option({next:null}),e(n),i},this.$terminal.register("command",{name:"answer",method:this.answer.bind(this),regex:/answer/}),this.$terminal.set_command_option({next:"answer"})})}formatGrid(e,t=!0,i=null,n=!1){if(n){let i=[];return e.forEach(e=>{e.forEach((e,t)=>{if(!i[t])return void(i[t]=e.length);let n=i[t];e.length>n&&(i[t]=e.length)})}),e.map(e=>e.map((e,n)=>t?e.padStart(i[n]):e.padEnd(i[n])))}if(null===i){var a=e.reduce((e,t)=>{var i=t.reduce((e,t)=>e>t.length?e:t.length,0);return e>i?e:i},0);i=a}return e.map(e=>e.map(e=>t?e.padStart(i):e.padEnd(i)))}printGrid(e,t=" ",i="\n",n=!1){for(var a=[],s=0;s<e.length;s++){var r=e[s].join(t);a.push(r+"\n")}var o=a.join(i);return n&&this.$terminal.echo(o),o}}const h=new o,l=new o(!1),c=new o(!1);let m=275,d=50;class u{constructor(e,t){if(!e.propName)throw new Error("To inherit component you need to define a static propName");this.parent=t,this.parent[e.propName]=this,this.parent.hasComponent=u.hasComponent.bind(this.parent)}static hasComponent(e){return this[e.propName]}}class p extends u{constructor(e,t,i=0,n=0,a=1){super(p,e),this.health=a,this.maxHealth=this.health,this.terminal=h,this.width=i,this.length=n,this.gameObject=t,this._indestructible=!1}static propName(){return"collider"}static setDeviceDamageRange(e,t){d=e,m=t}static get minHitToDamageDevices(){return d}static get maxHitToDamageDevices(){return m}repair(){this.health=this.maxHealth}makeIndestructible(){this._indestructible=!0}getCoordinates(){let e={x:this.gameObject.x,y:this.gameObject.y},t={x:e.x,y:e.y+this.length},i={x:e.x+this.width,y:e.y};return{topLeft:e,bottomLeft:t,topRight:i,bottomRight:{x:i.x,y:t.y},center:{x:e.x+this.width/2,y:e.y+this.width/2}}}getLeftSideX(){return this.gameObject.x}getRightSideX(){return this.gameObject.x+this.width/100}getTopSideY(){return this.gameObject.y}getBottomSideY(){return this.gameObject.y+this.length/100}collision(e){return e.collider?p.collision(this,e.collider):(console.log(e," is not a collider."),!1)}static collision(e,t){return!e instanceof p||!t instanceof p?(console.error("both a and b need to be colliders, ",e,t),!1):e!==t&&(e.getLeftSideX()<t.getRightSideX()&&e.getRightSideX()>t.getLeftSideX()&&e.getTopSideY()<t.getBottomSideY()&&e.getBottomSideY()>t.getTopSideY())}hitWillDamageDevices(e){let t=Math.random()*(p.maxHitToDamageDevices-p.minHitToDamageDevices)+p.minHitToDamageDevices;return console.log("device damage threshold = ",t),e>t}takeHit(e){if(this._indestructible)this.terminal.printLine(`Consumed by ${this.gameObject.name} at ${this.gameObject.getSectorLocation()}`);else{if(this.health-=e,this.terminal.printLine(`${e.toFixed(2)} unit hit on ${this.gameObject.name} at ${this.gameObject.getSectorLocation()}`),He&&this.hitWillDamageDevices(e)&&this.parent.deviceContainer){let t=e/(25*Math.random()*75);this.parent.deviceContainer.damageRandomDevices(t)}this.health<=0&&(this.parent.die?this.parent.die():this.terminal.echo(`${this.gameObject.name} destroyed.`))}}}class g extends u{constructor(e,t){super(g,e),this.gameObject=t}static get propName(){return"mover"}calculateDisplacement(e){return{x:e.globalX-this.gameObject.sector.globalX,y:e.globalY-this.gameObject.sector.globalY}}calculateDestination(e=0,t=0,i=0,n=0){let a=this.gameObject.sector,s=a.globalX+10*e+i,r=a.globalY+10*t+n;return this.gameObject.galaxy.getSectorGlobal(s,r)}static calculateDistance(e,t,i,n){let a=Math.abs(i-e),s=Math.abs(n-t);return Math.hypot(a,s)}*moveInDirection(e,t=.5,i){let n=t*Math.cos(e),a=t*Math.sin(e)*-1,s=0,r=!0;for(;r;){if(s>1e3)return;this.gameObject.x+=n,this.gameObject.y+=a,this.gameObject.updateCoordinates(),r=yield,s++}}*moveTo(e,t,i=.5){let n=g.calculateDistance(this.gameObject.x,this.gameObject.y,e,t),a=Math.atan2(this.gameObject.y-t/this.gameObject.x-e),s=i*Math.cos(a),r=i*Math.sin(a),o=!0;for(;n>0&&o;){let a=Math.abs(e-this.gameObject.x),h=Math.abs(t-this.gameObject.y);if(a<s&&(s=e-this.gameObject.x),h<r&&(r=t-this.gameObject.y),this.gameObject.x+=s,this.gameObject.y+=r,this.gameObject.updateCoordinates(),(n-=i)<=0)return;o=yield}}moveToSector(e){e.isFull(),this.gameObject.sector.container.removeGameObject(this.parent),this.gameObject.quadrant.container.removeGameObject(this.parent),this.gameObject.placeIn(this.gameObject.galaxy,e.quadrant,e)}}class y extends u{constructor(e){super(y,e),this.gameObjects=[]}static get propName(){return"container"}isEmpty(){return 0===this.gameObjects.length}getCountOfGameObjects(e){return this.gameObjects.reduce((t,i)=>(i instanceof e&&t++,t),0)}getGameObjectsOfType(e){return this.gameObjects.filter(t=>t instanceof e)}getAllGameObjects(){return this.gameObjects.slice()}addGameObject(e){this.gameObjects.push(e)}removeGameObject(e){this.gameObjects=this.gameObjects.filter(t=>t!==e)}}class f extends u{constructor(e,t=!1){super(f,e),this.galaxy=null,this.quadrant=null,this.sector=null,this._x=null,this._y=null,this.takesWholeSector=t}static get propName(){return"gameObject"}isInGame(){return!!(this.galaxy&&this.quadrant&&this.sector)}get name(){return this.parent.name?this.parent.name:this.parent.constructor.name}removeSelf(){this.galaxy.container.removeGameObject(this.parent),this.quadrant.container.removeGameObject(this.parent),this.sector.container.removeGameObject(this.parent),this.galaxy=null,this.quadrant=null,this.sector=null,this.x=null,this.y=null,this.userSectorX=null,this.userSectorY=null,this.userQuadrantX=null,this.userQuadrantY=null}updateCoordinates(){try{let e=this.galaxy.getSectorGlobal(this.x,this.y);if(e!==this.sector){if(!this.canMoveTo(e))throw new Error("Cant place object in non empty sector");this.quadrant.container.removeGameObject(this.parent),this.sector.container.removeGameObject(this.parent),this.quadrant=e.quadrant,this.sector=e}(this.x%this.quadrant.width+.5).toFixed(1),(this.y%this.quadrant.width+.5).toFixed(1);this.userSectorX=this.sector.x+1,this.userSectorY=this.sector.y+1,this.userQuadrantX=this.quadrant.x+1,this.userQuadrantY=this.quadrant.y+1}catch(e){this.removeSelf()}}canMoveTo(e){return!(this.takesWholeSector&&!e.container.isEmpty())}placeIn(e,t,i,n=.5,a=.5){if(!this.canMoveTo(i))throw new Error("Cant place object in non empty sector");this.galaxy=e,this.quadrant=t,this.sector=i,this.galaxy.container.addGameObject(this.parent),this.quadrant.container.addGameObject(this.parent),this.sector.container.addGameObject(this.parent),this.x=this.sector.globalX+n,this.y=this.sector.globalY+a,this.updateCoordinates()}getSectorLocation(e=!0,t){return`${e?"Sector ":""}${this.userSectorX} - ${this.userSectorY}`}getSectorLocationFloat(e=!0){return`${e?"Sector ":""}${(this.x%this.quadrant.width+.5).toFixed(1)} - ${(this.y%this.quadrant.width+.5).toFixed(1)}`}getLocation(){return`${this.getQuadrantLocation()}; ${this.getSectorLocation()}`}getQuadrantLocation(){return`Quadrant ${this.userQuadrantX} - ${this.userQuadrantY}`}}class b{constructor(e,t,i){this.container=new y(this),this.quadrant=i,this.galaxy=i.galaxy,this.x=e,this.y=t;let n=this.galaxy.getGlobalCoordinates(this);this.globalX=n.x,this.globalY=n.y}getAdjacentSectors(e=!1){return this.quadrant.getSectorsAdjacentTo(this,e)}isFull(){return this.container.getAllGameObjects().some(e=>e.gameObject.takesWholeSector)}}class w{constructor(e,t,i,n,a){this.container=new y(this),this.galaxy=a,this.x=i,this.y=n;let s=this.galaxy.getGlobalCoordinatesForQuadrant(this);this.globalX=s.x,this.globalY=s.y,this.width=e,this.length=t,this.sectors=[],this.hasSupernova=!1;for(let e=0;e<this.length;e++){let t=[];for(let i=0;i<this.width;i++)t.push(new b(i,e,this));this.sectors.push(t)}}getSectorsAdjacentTo(e,t=!1){if(!e instanceof b)return[];let i=e.x,n=e.y,a=[];for(let e=n-1;e<=n+1;e++)for(let s=i-1;s<=i+1;s++)this.areValidCoordinates(s,e)&&(t||s!==i&&e!==n)&&a.push(this.sectors[e][s]);return a}areValidCoordinates(e,t){return!(t<0||t>this.length-1)&&!(e<0||e>this.width-1)}getRandomSector(){let e=Math.round(Math.random()*(this.width-1)),t=Math.round(Math.random()*(this.length-1));return this.sectors[t][e]}getSector(e,t){if(!this.areValidCoordinates(e,t))throw new Error(`There is no sector ${e} - ${t}.`);return e=Math.trunc(e),t=Math.trunc(t),this.sectors[t][e]}isFull(){return!!this.hasSupernova||this.sectors.every(e=>e.every(e=>!e.container.isEmpty()))}getRandomEmptySector(){let e=this.sectors.map(e=>e.filter(e=>e.container.isEmpty())).flat();if(0!==e.length)return e[Math.round(Math.random()*(e.length-1))]}getEdge(e,t,i){return{x:0,y:0}}}class v{constructor(e,t,i=10,n=10,a=!0){this.container=new y(this),this.width=e,this.length=t,this.quadrantWidth=i,this.quadrantLength=n,this.quadrants=[];for(let i=0;i<t;i++)this.quadrants.push(new Array(e));if(a)for(let e=0;e<this.quadrants.length;e++){let t=this.quadrants[e];for(let i=0;i<t.length;i++)t[i]=new w(this.quadrantWidth,this.quadrantLength,i,e,this)}}static calculateDistance(e,t){let i=Math.abs(e.globalX-t.globalX),n=Math.abs(e.globalY-t.globalY);return Math.hypot(i,n)}static convertUserCoordinates(e,t){return{x:e-.5,y:t-.5}}getRandomQuadrant(){let e=Math.round(Math.random()*(this.width-1)),t=Math.round(Math.random()*(this.length-1));return this.quadrants[t][e]}getRow(e){return this.quadrants[e]}getGlobalCoordinates(e){return{x:e.quadrant.x*this.quadrantWidth+e.x,y:e.quadrant.y*this.quadrantLength+e.y}}getGlobalCoordinatesForQuadrant(e){return{x:e.x*this.quadrantWidth,y:e.y*this.quadrantLength}}getSectorGlobal(e,t){let i=Math.floor(e/this.quadrantWidth),n=Math.floor(t/this.quadrantLength),a=Math.floor(e%this.quadrantWidth),s=Math.floor(t%this.quadrantLength);return this.getSector(i,n,a,s)}getSector(e,t,i,n){return this.getQuadrant(e,t).getSector(i,n)}getQuadrant(e,t){if(t<0||t>this.length-1)throw new Error(`There is no quadrant ${e+1} - ${t+1}.`);if(e<0||e>this.width-1)throw new Error(`There is no quadrant ${e+1} - ${t+1}.`);return this.quadrants[t][e]}}window.Galaxy=v;class S extends u{constructor(e,t,i){super(S,e),this.parent=e,this.parent.ai=this,this.galaxy=t,this.player=i}static get propName(){return"ai"}takeTurn(){console.log(`${this.parent.name} taking a turn.`),this.firePhasers()}firePhasers(){let e=this.parent.powerGrid.capacity*(.4*Math.random()+.2);0!==(e=Math.min(e,this.parent.powerGrid.energy))?this.parent.phasers.isOk()&&(this.parent.phasers.fire(e,this.player),this.parent.powerGrid.useEnergy(e),this.parent.phasers.coolDown()):console.error("OUT OF ENERGY")}}var O=function(e){return e=e||Object.create(null),{on:function(t,i){(e[t]||(e[t]=[])).push(i)},off:function(t,i){e[t]&&e[t].splice(e[t].indexOf(i)>>>0,1)},emit:function(t,i){(e[t]||[]).slice().map((function(e){e(i)})),(e["*"]||[]).slice().map((function(e){e(t,i)}))}}};var x=new class{constructor(){this.emitter=new O,this._initialStarDate=null,this._starDate=null}init(e){this._initialStarDate=e,this._starDate=e}get starDate(){return this._starDate}getElapsedTime(){return this._starDate-this._initialStarDate}elapseTime(e){this._starDate+=e,this.emitter.emit("timeElapse",e)}unregister(e){this.emitter.off("timeElapse",e)}register(e){this.emitter.on("timeElapse",e)}};class k{constructor(e,t){this.name=e,this.propName=t,Object.freeze(this)}}const T=new k("Short Range Sensors","shortRangeSensors"),C=(new k("Long Range Sensors","longRangeSensors"),new k("Phasers","phasers")),E=new k("Power Circuits","powerGrid"),L=new k("Warp Engines","warpEngines"),j=new k("Impulse Engines","impulseEngines"),M=new k("Life Support","lifeSupport"),R=new k("Shields","shields"),D=new k("Photon Torpedo Launcher","photons");class N extends u{constructor(e,t,i=.65){super(t,e),this.parent=e,this.name=t.name,this.type=t,this._chanceOfBeingDamaged=i,this.parent.deviceContainer||(this.parent.deviceContainer=new A(this.parent)),this.parent.deviceContainer.addDevices(this),this._damage=0}isType(e){return!(!e instanceof k)&&this.type.name===e.name}get damage(){return this._damage}checkDamage(){if(this.isDamaged())throw new Error(`${this.name} is damaged!`)}isOk(){return 0===this._damage}isDamaged(){return this._damage>0}takeDamage(e){0===this._damage&&h.printLine(`***${this.parent.name}'s ${this.name} has been damaged.`),this._damage+=e}repair(e){0!==this._damage&&(this._damage-=e,0===this._damage&&h.printLine(`${this.parent.name}'s ${this.name} have been repaired.`),this._damage=Math.max(this._damage,0))}randomlyDamage(){this.takeDamage(5*Math.random())}hitDoesDamage(){return Math.random()<this._chanceOfBeingDamaged}timeToRepairInFlight(){return 3.5*this._damage}timeToRepairAtDock(){return this._damage}}class A{constructor(e){this.parent=e,this.parent.deviceContainer=this,this.devices=[],this.onTimeElapse=this.onTimeElapse.bind(this),x.register(this.onTimeElapse)}onTimeElapse(e){let t=this.devices.filter(e=>e.isDamaged()),i=e/t.length;t.forEach(e=>e.repair(i))}addDevices(...e){this.devices.push(...e)}getRandomDevice(){let e=Math.trunc(this.devices.length*Math.random());return this.devices[e]}damageRandomDevices(e){let t=Math.max(e/10,2),i=e;for(;e>0;){let n,a=Math.max(i*Math.random(),t);do{n=this.getRandomDevice()}while(n.hitDoesDamage());n.takeDamage(a),e-=a}}getDevice(e){return this.parent[e.propName]}}class _ extends N{constructor(e,t){super(t,E,.12),this.capacity=e,this._energy=e}get energy(){return this._energy}set energy(e){e=Math.min(e,this.capacity),e=Math.max(e,0),this._energy=e}getPercent(){return this._energy/this.capacity}atMax(){return this._energy===this.capacity}recharge(){this._energy=this.capacity}useEnergy(e){if(this.checkDamage(),this._energy-e<-.01)throw new Error("Not enough energy!");this._energy-=e}addEnergy(e){if(this.checkDamage(),this._energy+e>this.capacity)throw new Error("Too much energy.");this._energy+=e}}class P extends N{constructor(e,t){super(e,L),this.powerGrid=t,this._warpFactor=5}get warpFactor(){return this._warpFactor}set warpFactor(e){this.checkDamage(),"number"!=typeof e||Number.isNaN(e)||e<1||e>10||(this._warpFactor=e)}}class I extends N{constructor(e,t){super(e,j),this.powerGrid=t}}class G extends N{constructor(e,t,i){super(e,M),this.maxReserves=t,this.reserves=t,this.onTimeElapsed=this.onTimeElapsed.bind(this),this.clock=i,this.clock.register(this.onTimeElapsed),this.terminal=h}kill(){this.clock.unregister(this.onTimeElapsed)}atMax(){return this.reserves===this.maxReserves}recharge(){this.checkDamage(),this.reserves=this.maxReserves}onTimeElapsed(e){this.isDamaged()?(this.reserves-=e,this.reserves=Math.max(this.reserves,0),0===this.reserves&&(this.parent.die&&this.parent.die(),this.terminal.printLine(`${this.parent.name}'s crew suffocates.`))):this.isDamaged()||this.atMax()||this.recharge()}}class q extends N{constructor(e,t){super(e,R),this.capacity=t,this.up=!1,this.units=this.capacity,this.terminal=h}printInfo(){return`${this.up?"UP":"DOWN"}, ${this.units.toFixed(2)} ${(100*this.units/this.capacity).toFixed(1)}%`}recharge(){this.checkDamage(),this.units=this.capacity}lower(){this.checkDamage(),this.up?(this.up=!1,this.terminal.printLine("Shields lowered.")):this.terminal.printLine("Shields already down.")}raise(){this.checkDamage(),this.up?this.terminal.printLine("Shields already up."):this.isDamaged()?this.terminal.printLine("Shields are damaged."):(this.up=!0,this.terminal.printLine("Shields raised."))}drain(e){if(this.checkDamage(),this.units-e<0)throw new Error("Not enough energy");return this.units-=e,0===this.units&&this.lower(),this.units}charge(e){this.checkDamage(),this.units+e>this.capacity&&(e=this.capacity-this.units),this.units+=e,this.units===this.capacity&&this.terminal.printLine("Shields at max.")}takeHit(e){this.up&&!this.isDamaged()?(this.terminal.printLine(`${e.toFixed(2)} hit to shields.`),this.units<e?(e-=this.units,this.drain(this.units),this.parent.collider.takeHit(e)):this.drain(e)):this.parent.collider.takeHit(e)}}class F extends N{constructor(e,t){if(super(e,C),!t)throw new Error("Phaser must have energy");this.energySystem=t,this.overheated=!1,this.amountRecentlyFired=0,this.overheatThreshold=1500,this.terminal=h,this.scalingFactor=.9,this.maxScalingFactor=this.scalingFactor+.01,this.minScalingFactor=this.scalingFactor}calculateSureKill(e,t){return t/this.minScalingFactor**e}calculateDamage(e,t){return t*(this.scalingFactor+.01*Math.random())**e}coolDown(){this.amountRecentlyFired=0}checkOverHeat(){if(this.amountRecentlyFired>this.overheatThreshold){let e=this.amountRecentlyFired-this.overheatThreshold;Math.random()<=.0038*e&&(this.terminal.printLine("Phasers overheated!"),this.randomlyDamage())}}fire(e,t){if(e<=0)return void console.error("Can't fire amount ",e);if(!t)return void console.error("Need a target, ",t);if(!(t.collider instanceof p))return void console.error("You can't hit that",t);if(this.checkDamage(),this.isDamaged())return void this.terminal.printLine("Phaser control damaged.");if(!this.parent.gameObject)return void console.error("derp a lerp.");if(!t.gameObject||!t.gameObject.isInGame())return void console.error("Can't shoot something removed from the game.");let i=Galaxy.calculateDistance(this.parent.gameObject.sector,t.gameObject.sector),n=this.calculateDamage(i,e);t.shields instanceof q?t.shields.takeHit(n):t.collider instanceof p&&t.collider.takeHit(n),this.amountRecentlyFired+=e,this.checkOverHeat()}}class H{constructor(){this.gameObject=new f(this,!1),this.mover=new g(this,this.gameObject),this.collider=new p(this,this.gameObject,100,100,1),this.damage=100}die(){this.gameObject.removeSelf()}}class K extends N{constructor(e,t=0,i=0){super(e,D),this.terminal=h,this._capacity=i,this._torpedoes=t}addTorpedoes(e){this.checkDamage(),e<=0||(this._torpedoes+e>this._capacity?this._torpedoes=this._capacity:this._torpedoes+=e)}getTorpedoCount(){return this._torpedoes}calcAngleDegrees(e,t){return 180*Math.atan2(t,e)/Math.PI}fire(e,t){if(this.checkDamage(),this.isDamaged())return void this.terminal.echo("Photon torpedoes are damaged and can't fire.");if(this._torpedoes<=0)return void this.terminal.echo("Not enough torpedoes.");this._torpedoes--;let i=this.parent.gameObject.quadrant.globalX+e,n=this.parent.gameObject.quadrant.globalY+t,a=new H;a.gameObject.placeIn(this.parent.gameObject.galaxy,this.parent.gameObject.quadrant,this.parent.gameObject.sector);let s,r=this.parent.gameObject.quadrant,o=i-this.parent.gameObject.x,h=-1*(n-this.parent.gameObject.y),l=Math.atan2(h,o),c=a.mover.moveInDirection(l,.5,Math.hypot(o,h)),m=!1,d=null,u=[];do{if(s=c.next(!0),a.gameObject.quadrant!==r){console.log("We've left the quadrant.",r,a.gameObject.quadrant),c.next(!1);break}if(u.push(a.gameObject.getSectorLocationFloat(!1)),a.gameObject.sector.getAdjacentSectors(!0).forEach(e=>{m||e.container.getAllGameObjects().forEach(e=>{m||e.collider&&e!==a&&e!==this.parent&&(m=a.collider.collision(e))&&(d=e,console.log("HIT!!!",e))})}),m){c.next(!1);break}}while(!s.done);for(let e=0;e<u.length;e++)0===e?this.terminal.echo(`${u[e]}    `):e===u.length-1?this.terminal.echo(`${u[e]}`):e%2==0&&this.terminal.echo(`${u[e]}    `);this.terminal.echo("\n"),m?d.collider.takeHit(a.damage):this.terminal.printLine("Torpedo missed and has left the quadrant!"),a.die()}}class B{constructor(){this.kHealth=40,this.kEnergy=400,this.kcHealth=100,this.kcEnergy=1200,this.kscHealth=400,this.kscEnergy=1750,this.rHealth=40,this.rEnergy=700}makeKlingon(e,t,i,n,a){let s=new Y(e,t,i);return s.collider.health=this.kHealth,s.powerGrid.energy=this.kEnergy,s.gameObject.placeIn(e,n,a),s}makeKlingonCommander(e,t,i,n,a){let s=new z(e,t,i);return s.collider.health=this.kcHealth,s.powerGrid.energy=this.kcEnergy,s.gameObject.placeIn(e,n,a),s}makeKlingonSuperCommander(e,t,i,n,a){let s=new W(e,t,i);return s.collider.health=this.kscHealth,s.powerGrid.energy=this.kscEnergy,s.gameObject.placeIn(e,n,a),s}makeRomulan(e,t,i,n,a){let s=new V(e,t,i);return s.collider.health=this.rHealth,s.powerGrid.energy=this.rEnergy,s.gameObject.placeIn(e,n,a),s}}class U{constructor(e,t,i){this.powerGrid=new _(200,this),this.galaxy=e,this.player=t,this.game=i,this.gameObject=new f(this,!0),this.collider=new p(this,this.gameObject,80,80),this.phasers=new F(this,this.powerGrid),this.lifeSupport=new G(this,2,x),this.ai=new S(this,e,t),this.terminal=h,this.name=this.constructor.name}die(){this.lifeSupport.kill(),this.terminal.printLine(`${this.name} at ${this.gameObject.getSectorLocation()} was destroyed.`),console.log("You killed ",this),this.gameObject.removeSelf(),this.game.killEnemy(this)}}class Q extends U{constructor(e,t,i){super(e,t,i)}}class Y extends Q{constructor(e,t,i){super(e,t,i),this.collider.health=40,this.powerGrid.energy=400,this.name="Klingon Warbird"}}class z extends Q{constructor(e,t,i){super(e,t,i),this.collider.health=100,this.powerGrid.energy=1200,this.name="Klingon Commander"}}class W extends Q{constructor(e,t,i){super(e,t,i),this.collider.health=400,this.powerGrid.energy=1750,this.name="Klingon Super Commander"}}class V extends U{constructor(e,t,i){super(e,t,i),this.collider.health=40,this.powerGrid.energy=700,this.name="Romulan"}}const X=1,J=2,Z=3,ee=4;class te{constructor(e,t){this.gameObject=new f(this),this.mover=new g(this,this.gameObject),this.deviceContainer=new A(this),this.powerGrid=new _(3e3,this),this.collider=new p(this,this.gameObject,80,80,1500),this.warpFactor=5,this.docked=!1,this.dockedAt=null,this.name="Enterprise",this.dead=!1,this.terminal=e,this.phasers=new F(this,this.powerGrid),this.photons=new K(this,10,10),this.shields=new q(this,2500,this.powerGrid),this.shortRangeSensors=new N(this,T),this.lifeSupport=new G(this,4,t),this.warpEngines=new N(this,L),window.e=this}isDead(){return this.lifeSupport.reserves<=0||this.dead}die(){this.lifeSupport.kill(),this.terminal.echo("Enterprise destroyed!!!!\n"),this.dead=!0,this.gameObject.removeSelf()}firePhasersMultiTarget(e){let t=e.reduce((e,t)=>e+t.amount,0);if(t>this.powerGrid.energy)throw new Error("Not enough energy.");this.powerGrid.useEnergy(t),e.forEach(e=>{this.phasers.fire(e.amount,e.enemy)}),this.phasers.coolDown()}repairHull(){this.collider.repair()}dock(e){this.docked||(this.powerGrid.recharge(),this.photons.addTorpedoes(this.photons._capacity-this.photons.getTorpedoCount()),this.shields.recharge(),this.repairHull(),this.docked=!0,this.dockedAt=e)}undock(){this.docked=!1,this.dockedAt=null}impulseTo(e){this.mover.moveToSector(e)}setWarpFactor(e){"number"!=typeof e||Number.isNaN(e)||e<1||e>10||(this.warpFactor=e)}warpTo(e){if(!e instanceof b)throw new Error("Can't move there");this.docked&&this.undock();let t=.1*Galaxy.calculateDistance(this.gameObject.sector,e)*Math.pow(this.warpFactor,3);if(this.shields.up&&(t*=2),console.log(t),this.powerGrid.energy<t)throw new Error("Not enough energy.");this.mover.moveToSector(e),this.powerGrid.useEnergy(t)}getCondition(){let e=this.gameObject.quadrant.container.getCountOfGameObjects(U);return this.docked?ee:e>0?Z:this.powerGrid.energy<1e3?J:X}shieldsUp(){this.powerGrid.useEnergy(50),this.shields.raise()}shieldsDown(){this.shields.lower()}printCondition(){switch(this.getCondition()){case ee:return"DOCKED";case X:return"GREEN";case J:return"YELLOW";case Z:return"RED";default:console.error("condition not recognized.")}}}class ie{constructor(){this.gameObject=new f(this,!0),this.collider=new p(this,this.gameObject,80,80,1e3),this.collider.makeIndestructible(),this.name="Star"}}class ne{constructor(){this.gameObject=new f(this,!0),this.collider=new p(this,this.gameObject,100,100,1e3),this.name="star base"}}class ae{constructor(e,t,i=!1){this.gameObject=new f(this,!0),this.collider=new p(this,this.gameObject,80,80,1e3),this._planetClass=null,this.planetClass=e,this.hasCrystals=t,this.known=!1,this.name="planet"}get planetClass(){return this._planetClass}set planetClass(e){if(e){if("m"!==(e=e.toLowerCase())&&"n"!==e&&"o"!==e)throw new Error(`Planet Class ${e} invalid.`);this._planetClass=e}}randomlyGenerate(){let e=Math.random();this.planetClass=e>2/3?"m":e>1/3?"n":"o",this.hasCrystals=Math.random()>2/3}}class se{constructor(){this.gameObject=new f(this,!0),this.collider=new p(this,this.gameObject,100,100),this.collider.makeIndestructible(),this.name="black hole"}}function re(...e){return e=(e=e.sort((e,t)=>t.length-e.length)).map(e=>e+"\\s*"),new RegExp(`^\\s*(${e.join("|")})\\s*$`,"i")}function oe(...e){return e=(e=e.sort((e,t)=>t.length-e.length)).map(e=>e+"(\\s+|$)"),new RegExp(`^\\s*(${e.join("|")})\\s*`,"i")}const he="info",le="attack",ce="move",me="not instant ship command",de="instant ship command";class ue{constructor(){this.abbreviation=null,this.name=null,this.regex=null,this.fullName=null,this.deviceUsed="",this.info="No info.",this.type=null,this.options={},this.modes={}}addOption(e,...t){this.options[e]=re(...t)}addMode(e,...t){this.modes[e]=re(...t)}getOption(e){let t={};return Object.keys(this.options).forEach(i=>{t[i]=e.some(e=>this.options[i].test(e))}),t}getMode(e){let t={};return Object.keys(this.modes).forEach(i=>{t[i]=this.modes[i].test(e[0])}),t}isInstantShipCommand(){return this.type===de}isInfoCommand(){return this.type===he}isAttackCommand(){return this.type===le}isMoveCommand(){return this.type===ce}makeInfo(){}}class pe extends ue{constructor(e,t){super(),this.game=e,this.terminal=t,this.name="rest",this.regex=oe(this.name),this.type=me,this.info=""}run(){let e=Number.parseFloat(this.terminal.getArguments());this.game.clock.elapseTime(e)}}class ge extends ue{constructor(e,t){super(),this.terminal=e,this.player=t,this.abbreviation="w",this.name="warp",this.fullName="Warp Factor",this.regex=oe(this.abbreviation,this.name,this.fullName),this.type=de,this.info='\n  Mnemonic:  WARP\n  Shortest abbreviation:  W\n  Full command:  WARP <number>\n\nYour warp factor controls the speed of your starship.  The larger the\nwarp factor, the faster you go and the more energy you use.\n\nYour minimum warp factor is 1.0 and your maximum warp factor is 10.0\n(which is 100 times as fast and uses 1000 times as much energy).  At\nspeeds above warp 6 there is some danger of causing damage to your\nwarp engines; this damage is larger at higher warp factors and also\ndepends on how far you go at that warp factor.\n\nAt exactly warp 10 there is some probability of entering a so-called\n"time warp" and being thrown forward or backward in time.  The farther\nyou go at warp 10, the greater is the probability of entering the\ntime warp.'}run(){let e=Number.parseFloat(this.terminal.getArguments()[0]);if(Number.isNaN(e))this.terminal.printLine("Beg your pardon, Captain?");else{if(e<1)this.terminal.printLine('Helmsman Sulu- "We can\'t go below warp 1, Captain."');else if(e<=6)this.terminal.printLine(`Helmsman Sulu- "Warp factor ${e.toFixed(1)}, Captain."`);else if(e<8)this.terminal.printLine('Engineer Scott- "Aye, but our maximum safe speed is warp 6."');else if(e>=8&&e<10)this.terminal.printLine('Engineer Scott- "Aye, Captain, but our engines may not take it."');else if(10===e)this.terminal.printLine('Engineer Scott- "Aye, Captain, we\'ll try it."');else{if(!(e>10))return void this.terminal.printLine("Beg your pardon, Captain?");this.terminal.printLine('Helmsman Sulu- "Our top speed is warp 10, Captain."')}this.player.setWarpFactor(e)}}}class ye extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.abbreviation="da",this.name="damages",this.fullName="damage report",this.regex=oe(this.abbreviation,this.name,"damage",this.fullName),this.type=he,this.addOption("alpha","a","alpha","alphabetically"),this.addOption("all","all"),this.info="\n  Mnemonic:  DAMAGES\n  Shortest abbreviation:  DA \n  Syntax: [command] [options]\n  Options: all, alpha \n  \n    example usage : \n    COMMAND> damage alpha    \n    - sorted by alphabetically by device name\n    COMMAND> da\n    - sorted by time \n    COMMAND> da all\n    - show all devices, sort by default (damage descending)\n    \n========    DETAILS =========    \nAt any time you may ask for a damage report to find out what devices\nare damaged and how long it will take to repair them.  Naturally,\nrepairs proceed faster at a starbase.\n\nIf you suffer damages while moving, it is possible that a subsequent\ndamage report will not show any damage.  This happens if the time\nspent on the move exceeds the repair time, since in this case the\ndamaged devices were fixed en route.\n\nDamage reports are free.  They use no energy or time, and can be done\nsafely even in the midst of battle."}run(){let{alpha:e,all:t}=this.getOption(this.terminal.getArguments()),i=this.player.deviceContainer.devices.slice();if(e?i.sort((e,t)=>e.name.localeCompare(t.name)):i.sort((e,t)=>t.damage-e.damage),t||(i=i.filter(e=>e.damage>0)),0===i.length)return this.terminal.skipLine(1),this.terminal.printLine("All systems operational."),void this.terminal.skipLine(1);let n=[["DEVICE","","-REPAIR TIMES-"],["","IN FLIGHT","DOCKED"],...i.map(e=>[e.name,e.timeToRepairInFlight().toFixed(2),e.timeToRepairAtDock().toFixed(2)])];this.terminal.skipLine(1),this.terminal.printLine(this.terminal.printGrid(this.terminal.formatGrid(n,!1),"  ","")),this.terminal.skipLine(1)}}class fe extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.abbreviation="sc",this.name="score",this.regex=oe(this.abbreviation,this.name),this.type=he,this.info="\n  Mnemonic:  SCORE\n  Shortest abbreviation: SC\n\nShows what the score would be if the game were to end naturally at\nthis point. Since the game hasn't really ended and you lose points if\nyou quit, this is perhaps a meaningless command, but it gives you a\ngeneral idea of how well you are performing.\n        "}run(){let e=0,t=this.game.getNumberOfTypeKilled(Q),i=this.game.getNumberOfTypeKilled(Y),n=10*i,a=this.game.getNumberOfTypeKilled(z),s=50*a,r=this.game.getNumberOfTypeKilled(W),o=200*r,h=this.game.getNumberOfTypeKilled(V),l=20*h;e+=n+s+o+l;let c=this.game.clock.getElapsedTime();0===c&&(c=1);let m=t/c,d=500*m;e+=d;if(this.terminal.printLine("Your score --"),this.terminal.printLine(`${h} Romulan ships destroyed`.padEnd(60," ")+l),this.terminal.printLine(`${i} Klingon war birds destroyed`.padEnd(60," ")+n),this.terminal.printLine(`${a} Klingon Commander ships destroyed`.padEnd(60," ")+s),this.terminal.printLine(`${r} Klingon Super Commander ships destroyed`.padEnd(60)+o),this.terminal.printLine(`${m.toFixed(2)} Klingons per stardate`.padEnd(60)+d.toFixed(2)),this.game.isVictory()){let t=100*this.game.skill;e+=t,this.terminal.printLine(`Bonus for winning ${this.game.getDifficultyStr()} game `.padEnd(60)+t)}if(this.player.isDead()){let t=-200;e+=t,this.terminal.printLine("Penalty for getting yourself killed".padEnd(60)+t)}this.terminal.skipLine(2),this.terminal.printLine("TOTAL SCORE".padEnd(60)+e.toFixed(0))}}class be extends ue{constructor(e,t,i,n){super(),this.game=e,this.terminal=t,this.galaxy=i,this.abbreviation="rep",this.name="report",this.regex=oe(this.abbreviation,this.name),this.type=he,this.info="\n    Mnemonic:  REPORT\n    Shortest abbreviation: REP\n\nThis command supplies you with information about the state of the\ncurrent game.  Its purpose is to remind you of things that you have\nlearned during play, but may have forgotten, and cannot otherwise\nretrieve if you are not playing at a hard-copy terminal.\n\n     You are told the following things:\n\n       . The length and skill level of the game you are playing\n       . The original number of Klingons\n       . How many Klingons you have destroyed\n       . Whether the Super-Commander has been destroyed\n       . How many bases have been destroyed\n       . How many bases are left\n       . What bases (if any) are under attack; your subspace radio\n         must have been working since the attack to get this \n         information.\n       . How many casualties you have suffered\n       . How many times you have called for help.\n\nThis same information is automatically given to you when you start to\nplay a frozen game."}run(){this.terminal.printLine(`You are now playing a ${this.game.getGameLengthStr()} ${this.game.getDifficultyStr()} game.`);let e=this.game.getNumberOfTypeKilled(Q),t=this.game.getNumberOfTypeKilled(Y),i=this.game.getNumberOfTypeKilled(z),n=this.game.getNumberOfTypeKilled(W);this.terminal.printLine(`${e} of ${this.game.initialEnemies} klingons have been killed.`),this.terminal.printLine(`${t} klingon warbirds killed.`),this.terminal.printLine(`${i} klingon commanders killed.`),this.terminal.printLine(`${n} klingon super commanders killed.`);let a=this.galaxy.container.getCountOfGameObjects(ne);this.terminal.printLine(`There are ${a} remaining bases.`)}}class we extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.abbreviation="pho",this.name="photon",this.fullName="photon torpedoes",this.regex=oe(this.abbreviation,this.name,this.fullName,"photons","photon torpedo"),this.deviceUsed="",this.maxPerBurst=3,this.options={},this.type=le,this.info='\n  Mnemonic:  PHOTONS\n  Shortest abbreviation:  PHO\n  Full commands:  PHOTONS <NUMBER> <TARG1> <TARG2> <TARG3>\n\nPhoton torpedoes are projectile weapons--you either hit what you aim\nat, or you don\'t.  There are no "partial hits".\n\nOne photon torpedo will usually kill one ordinary Klingon, but it\nusually takes about two for a Klingon Commander.  Photon torpedoes\ncan also blow up stars and starbases, if you aren\'t careful.\n\nYou may fire photon torpedoes singly, or in bursts of two or three.\nEach torpedo is individually targetable.  The computer will prompt\nyou, asking for the target sector for each torpedo.  Alternately, you\nmay specify each target in the command line.\n\nPhoton torpedoes cannot be aimed precisely--there is always some\nrandomness involved in the direction they go.  Photon torpedoes may\nbe fired with your shields up, but as they pass through the shields\nthey are randomly deflected from their intended course even more.\n\nPhoton torpedoes are proximity-fused.  The closer they explode to the\nenemy, the more damage they do.  There is a hit "window" about one\nsector wide.  If the torpedo misses the hit window, it does not\nexplode and the enemy is unaffected.  Photon torpedoes are only\neffective within the quadrant.  They have no effect on things in\nadjacent quadrants.\n\nIf more than one torpedo is fired and only one target sector is\nspecified, all torpedoes are fired at that sector.  For example, to\nfire two torpedoes at sector 3 - 4, you type\n\n     PHO 2 3 4           (or)           PHO 2 3 4 3 4\n\nTo fire torpedoes at, consecutively, sectors 2 - 6, 1 - 10, and 4 -\n7, type\n\n     PHO 3 2 6 1 10 4 7\n\nThere is no restriction to fire directly at a sector.  For example,\nyou can enter\n\n       PHO 1 3 2.5\n\nto aim between two sectors.  However, sector numbers must be 1 to 10\ninclusive.\n\n'}run(){if(this.player.photons.isDamaged())return void this.terminal.echo("Torpedo launcher is damaged.");let e=this.terminal.getArguments(),t=e.shift(),i=[];for(let t=0;t<e.length;t+=2){let n=Number.parseFloat(e[t]),a=Number.parseFloat(e[t+1]);if(Number.isNaN(n)||Number.isNaN(a))return void this.terminal.echo(`${n} or ${a} is not a number.`);i.push({x:n,y:a})}if(t>this.maxPerBurst)return void this.terminal(`Maximum of ${this.maxPerBurst} torpedoes per burst.`);if(1===i.length)for(;i.length<t;){let e=Object.assign({},i[0]);i.push(e)}else{if(t<i.length)return void this.terminal.echo("Please specify destinations for every torpedo.");if(t>i.length)return void this.terminal.echo("Number of targets and the number to launch don't match.")}let n=this.player.photons.getTorpedoCount();t>n?this.terminal.echo(`You only have ${n} torpedoes.`):(i=i.map(e=>Galaxy.convertUserCoordinates(e.x,e.y))).forEach((e,t)=>{this.terminal.echo(`\nTrack for torpedo number ${t+1}:  `),this.player.photons.fire(e.x,e.y)})}}class ve extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.name="phasers",this.abbreviation="p",this.fullName="phasers",this.regex=oe(this.name,this.abbreviation,this.fullName),this.type=le,this.addOption("no","n","no"),this.addMode("auto","a","auto","automatic"),this.addMode("manual","m","man","manual"),this.info='\n  Mnemonic:  PHASERS\n  Shortest abbreviation:  P\n  Full commands:  PHASERS AUTOMATIC <AMOUNT TO FIRE> <NO>\n                  PHASERS <AMOUNT TO FIRE> <NO>\n                  PHASERS MANUAL <NO> <AMOUNT 1> <AMOUNT 2>...<AMOUNT N>\n\nPhasers are energy weapons. As you fire phasers at Klingons, you\nspecify an "amount to fire" which is drawn from your energy reserves.\nThe amount of total hit required to kill an enemy is partly random.\nbut also depends on skill level.\n\nThe average hit required to kill an ordinary Klingon varies from 200\nunits in the Novice game to 250 units in the Emeritus game.\nCommanders normally require from 600 (Novice) to 700 (Emeritus).  The\nSuper-commander requires from 875 (Good) to 1000 (Emeritus). Romulans\nrequire an average of 350 (Novice) to 450 (Emeritus).\n\nHits on enemies are cumulative, as long as you don\'t leave the\nquadrant.\n\nIn general, not all that you fire will reach the Klingons.  The\nfarther away they are, the less phaser energy will reach them. If a\nKlingon is adjacent to you, he will receive about 90% of the phaser\nenergy directed at him; a Klingon 5 sectors away will receive about\n60% and a Klingon 10 sectors away will receive about 35%. There is\nsome randomness involved, so these figures are not exact. Phasers\nhave no effect beyond the boundaries of the quadrant you are in.\n\nPhasers may overheat (and be damaged) if you fire too large a burst\nat once. Firing up to 1500 units is safe.  From 1500 on up the\nprobability of overheat increases with the amount fired.\n\nIf phaser firing is automatic, the computer decides how to divide up\nyour <amount to fire> among the Klingons present.  If phaser firing\nis manual, you specify how much energy to fire at each Klingon\npresent (nearest first), rather than just specifying a total amount.\nYou can abbreviate "MANUAL" and "AUTOMATIC" to one or more letters; if\nyou mention neither, automatic fire is usually assumed.\n\nBattle computer information is available by firing phasers manually,\nand allowing the computer to prompt you.  If you enter zero for the\namount to fire at each enemy, you will get a complete report, without\ncost.  The battle computer will tell you how much phaser energy to\nfire at each enemy for a sure kill.  This information appears in\nparentheses prior to the prompt for each enemy.  SInce the amount is\ncomputed from sensor data, if either the computer or the S.R. sensors\nare damaged, this information will be unavailable, and phasers must\nbe fired manually.\n\f                                                                       13\nA safety interlock prevents phasers from being fired through the\nshields.  If this were not so, the shields would contain your fire\nand you would fry yourself.  However, you may utilize the\n"high-speed shield control" to drop shields, fire phasers, and raise\nshields before the enemy can react.  Since it takes more energy to\nwork the shields rapidly with a shot, it costs you 200 units of\nenergy each time you activate this control.  It is automatically\nactivated when you fire phasers while the shields are up. By\nspecifying the <no> option, shields are not raised after firing.\n\nPhasers have no effect on starbases (which are shielded) or on stars.'}run(){let e=this.player.gameObject.quadrant,t=this.player.gameObject.sector,i=e.container.getGameObjectsOfType(U);if(0===i.length)return void this.terminal.printLine("No enemies to fire upon.");let n=this.terminal.getArguments(),{auto:a,manual:s}=this.getMode(n),{no:r}=this.getOption(n),o=r,h=[];a||s?h=n.slice(1):(a=!0,h=n.slice(0));if(a){let e=Number.parseInt(h[0]);if(Number.isNaN(e))return void this.terminal.printLine("Try again.");if(e<=0)return void this.terminal.printLine(`Can't fire ${e}, specify an amount greater than 0.`);if(e+200>this.player.powerGrid.energy)return void this.terminal.printLine(`Units available = ${this.player.powerGrid.energy}.`);let n=[];i.forEach(e=>{let i=Galaxy.calculateDistance(e.gameObject.sector,t),a=this.player.phasers.calculateSureKill(i,e.collider.health);n.push({enemy:e,distance:i,amount:a})}),n.sort((e,t)=>e.distance-t.distance);let a=[],s=e;for(let t=0;e>0&&t<n.length;t++){let{amount:e}=n[t];if(s<e&&(e=s),s-=e,n[t].amount=e,a.push(n[t]),s<=0)break}this.player.shields.up&&(this.terminal.printLine('Weapons Officer Sulu-  "High-speed shield control enabled, sir."'),this.player.shields.lower(),o?this.player.powerGrid.useEnergy(200):(this.player.shields.raise(),this.player.powerGrid.useEnergy(150))),this.player.firePhasersMultiTarget(a),s>0&&(this.terminal.echo(`Firing ${s.toFixed(2)} excess units into space.`),this.player.powerGrid.useEnergy(s))}else if(s){let e=h.map(e=>Number.parseInt(e));if(e.some(e=>Number.isNaN(e)))return void this.terminal.printLine("Try again.");if((e=e.filter(e=>e>0)).reduce((e,t)=>e+t,0)+200>this.player.powerGrid.energy)return void this.terminal.printLine(`Units available = ${this.player.powerGrid.energy}.`);if(i.length<e.length)return void this.terminal.printLine(`There are only ${i.length} enemies here.`);let n=[];i.forEach(e=>{n.push({enemy:e,distance:Galaxy.calculateDistance(e.gameObject.sector,t),amount:null})}),n.sort((e,t)=>e.distance-t.distance);let a=[];for(let t=0;t<e.length;t++){let i=n[t];i.amount=e[t],a.push(i)}this.player.shields.up&&(this.terminal.printLine('Weapons Officer Sulu-  "High-speed shield control enabled, sir."'),this.player.shields.shieldsDown(),o?this.player.powerGrid.useEnergy(200):(this.player.shieldsUp(),this.player.powerGrid.useEnergy(150))),this.player.firePhasersMultiTarget(a,!1)}}}class Se extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.name="shields",this.abbreviation="sh",this.fullName="deflector shields",this.regex=oe(this.abbreviation,this.name,this.fullName),this.info='  Mnemonic:  SHIELDS\n  Shortest abbreviation:  SH\n  Full commands:  SHIELDS UP\n                  SHIELDS DOWN\n                  SHIELDS CHARGE <amount of energy to put into the shields>\n                  SHIELDS DRAIN  <amount of energy to take from the shields>\n\nYour deflector shields are a defensive device to protect you from\nKlingon attacks (and nearby novas).  As the shields protect you, they\ngradually weaken.  A shield strength of 75%, for example, means that\nthe next time a Klingon hits you, your shields will deflect 75% of\nthe hit, and let 25% get through to hurt you.\n\nIt costs 50 units of energy to raise shields, nothing to lower them.\nYou may move with your shields up; this costs nothing under impulse\npower, but doubles the energy required for warp drive.\n\nEach time you raise or lower your shields, the Klingons have another\nchance to attack.  Since shields do not raise and lower\ninstantaneously, the hits you receive will be intermediate between\nwhat they would be if the shields were completely up or completely\ndown.\n\nYou may not fire phasers through your shields.  However you may use\nthe "high-speed shield control" to lower shields, fire phasers, and\nraise the shields again before the Klingons can react.  Since rapid\nlowering and raising of the shields requires more energy than normal\nspeed operation, it costs you 200 units of energy to activate this\ncontrol.  It is automatically activated when you fire phasers while\nshields are up.  You may fire photon torpedoes, but they may be\ndeflected considerably from their intended course as they pass\nthrough the shields (depending on shield strength).\n\nYou may transfer energy between the ship\'s energy (given as "Energy"\nin the status) and the shields.  Thee word "TRANSFER" may be\nabbreviated "T".  The amount of energy to transfer is the number of\nunits of energy you wish to take from the ship\'s energy and put into\nthe shields.  If you specify an negative number, energy is drained\nfrom the shields to the ship.  Transferring energy constitutes a turn.\nIf you transfer energy to the shields while you are under attack,\nthey will be at the new energy level when you are next hit.\n\nEnemy torpedoes hitting your ship explode on your shields (if they\nare up) and have essentially the same effect as phaser hits.'}getMode(e){let t=re("up","u"),i=re("down","d"),n=re("drain","dr"),a=re("charge","c");return{up:t.test(e),down:i.test(e),drain:n.test(e),charge:a.test(e)}}run(){let{up:e,down:t,charge:i,drain:n}=this.getMode(this.terminal.getArguments()[0]);if(!(e||t||i||n))return this.terminal.printLine("Beg pardon, Captain?"),void this.terminal.printLine("Valid options are : 'up', 'down', 'charge', or 'drain'.");if(e)this.player.shieldsUp();else if(t)this.player.shieldsDown();else if(i||n){let e=this.player.shields,t=this.player.powerGrid,a=this.terminal.getArguments()[1];if(a=Number.parseInt(a),Number.isNaN(a))return void this.terminal.printLine(`${a} is an gibberish amount to transfer captain.`);if(0===a)return void this.terminal.printLine("Beg pardon Captain?");if(e.isDamaged())return void this.terminal.echo("Shields damaged.");if(i){if(t.energy<a)return void this.terminal.printLine("Not enough energy, Captain.");if(e.units===e.capacity)return void this.terminal.printLine("Shields already at max, Captain.");e.units+a>e.capacity&&(a=e.capacity-e.units),this.terminal.printLine("Charging shields."),t.useEnergy(a),e.charge(a)}else if(n){if(a>e.units&&(this.terminal.printLine("Not enough energy in shields. Draining what we have."),a=e.units),t.atMax())return void this.terminal.printLine("Ship energy already at max.");t.energy+a>t.capacity&&(this.terminal.printLine("That would exceed our ship energy capacity. Setting ship energy to maximum."),a=t.capacity-t.energy),e.drain(a),t.addEnergy(a)}}}}class Oe extends ue{constructor(e,t){super(),this.game=e,this.terminal=t,this.name="commands",this.regex=oe("commands"),this.type=he,this.info='\n ABBREV    FULL COMMAND                             DEVICE USED\n ------    ------------                             -----------\n C         CHART                                    (none)\n D         DOCK                                     (none)\n L         LRSCAN                                   long-range sensors\n M         MOVE [MANUAL] [DISPLACEMENT]             warp engines\n           MOVE AUTOMATIC [DESTINATION]             warp engines and computer\n P         PHASERS [TOTAL AMOUNT]                   phasers and computer\n           PHASERS AUTOMATIC [TOTAL AMOUNT]         phasers, computer, sr sensors\n           PHASERS MANUAL [AMT1] [AMT2] ...         phasers\n PHO       PHOTONS [NUMBER] [TARGETS]               torpedo tubes \n REP       REPORT                                   (none)\n REQ       REQUEST                                  (none)\n S         SRSCAN [NO or CHART]                     short-range sensors\n SH        SHIELDS [UP, DOWN, or TRANSFER]          deflector shields\n ST        STATUS                                   (none)\n\n L. R. Scan:   thousands digit:   supernova\n               hundreds digit:    Klingons\n               tens digit:        starbases\n               ones digit:        stars\n               period (.):        digit not known (star chart only)\n\nCourses are given in manual mode in X - Y displacements; in automatic\n    mode as destination quadrant and/or sector.  Manual mode is default.\nDistances are given in quadrants.  A distance of one sector is 0.1 quadrant.\nOrdinary Klingons have about 400 units of energy, Commanders about\n    1200.  Romulans normally have about 800 units of energy, and the\n    (GULP) "Super-Commander" has about 1800.\nPhaser fire diminishes to about 60 percent at 5 sectors.  Up to 1500\n    units may be fired in a single burst without danger of overheat.'}printCommands(){let e=[],t=[];this.game.commands.map(e=>e.name).sort().forEach(i=>{4===t.length&&(e.push(t),t=[]),t.push(`${i}`)}),t.length>0&&e.push(t);let i=this.terminal.formatGrid(e,!1);return this.terminal.printGrid(i,"   ")}run(){this.terminal.newLine(),this.terminal.echo(this.printCommands())}}class xe extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.commandsCommand=i,this.abbreviation="help",this.name="help",this.regex=oe("help"),this.fullName="ask for help",this.type=he,this.info="  Mnemonic:  HELP\n  Full command:  HELP [command]\n\nThis command reads the appropriate section from the SST.DOC file,\nproviding the file is in the current directory."}async run(){this.terminal.newLine();let e=this.terminal.getArguments()[0];if(!e)do{e=await this.terminal.ask("Help on what command?")}while(!e);let t=this.game.commands.find(t=>t.regex.test(e));t?(this.terminal.echo('Spock- "Captain, I\'ve found the following information:"\n'),this.terminal.echo(t.info)):(this.terminal.echo("Valid Commands:\n"),this.terminal.echo(this.commandsCommand.printCommands())),this.terminal.newLine()}}class ke extends ue{constructor(e,t,i,n){super(),this.game=e,this.terminal=t,this.player=i,this.galaxy=n,this.abbreviation="",this.name="move",this.regex=oe("m","move"),this.fullName="move under warp drive",this.type=ce,this.info='  Mnemonic:  MOVE\n  Shortest abbreviation:  M\n  Full command:  MOVE MANUAL [displacement]\n                 MOVE AUTOMATIC [destination]\n\nThis command is the usual way to move from one place to another\nwithin the galaxy.  You move under warp drive, according to the\ncurrent warp factor (see "WARP FACTOR").\n\nThere are two command modes for movement: MANUAL and AUTOMATIC.  The\nmanual mode requires the following format:\n\n        MOVE MANUAL [deltax] [deltay]\n\n[deltax] and [deltay] are the horizontal and vertical displacements\nfor your starship, in quadrants; a displacement of one sector is 0.1\nquadrants.  Specifying [deltax] and [deltay] causes your ship to move\nin a straight line to the specified destination. If [deltay] is\nomitted, it is assumed zero. For example, the shortest possible\ncommand to move one sector to the right would be\n\n        M M .1\n\nThe following examples of manual movement refer to the short-range\nscan shown earlier.\n\n  Destination Sector    Manual Movement command\n        3 - 1                   M M -.3 -.1\n        2 - 1                   M M -.3\n        1 - 2                   M M -.2 .1\n        1 - 4                   M M 0 .1\n  (leaving quadrant)            M M 0 .2\n\n\nThe automatic mode is as follows:\n\n        MOVE AUTOMATIC [qrow] [qcol] [srow] [scol]\n\nwhere [qrow] and [qcol] are the row and column numbers of the\ndestination quadrant, and [srow] and [scol] are the row and column\nnumbers of the destination sector in that quadrant.  This command also\nmoves your ship in a straight line path to the destination.  For\nmoving within a quadrant, [qrow] and [qcol] may be omitted. For\nexample, to move to sector 2 - 9 in the current quadrant, the\nshortest command would be\n\n        M A 2 9\n\nTo move to quadrant 3 - 7, sector 5 - 8, type\n\n        M A 3 7 5 8\n\nand it will be done.  In automatic mode, either two or four numbers\nmust be supplied.\n\f                                                                       10\nAutomatic mode utilizes the ship\'s "battle computer."  If the\ncomputer is damaged, manual movement must be used.\n\nIf warp engines are damaged less than 10 stardates (undocked) you can\nstill go warp 4.\n\nIt uses time and energy to move.  How much time and how much energy\ndepends on your current warp factor, the distance you move, and\nwhether your shields are up.  The higher the warp factor, the faster\nyou move, but higher warp factors require more energy.  You may move\nwith your shields up, but this doubles the energy required.\n\nYou can move within a quadrant without being attacked if you just\nentered the quadrant or have bee attacked since your last move\ncommand.  This enables you to move and hit them before they\nretaliate.'}async moveTo(e){let t=Galaxy.calculateDistance(this.player.gameObject.sector,e),i=.1*t*Math.pow(this.player.warpFactor,3);if(this.player.shields.up&&(i*=2),this.player.powerGrid.energy<i)return this.terminal.printLine("Engineering to bridge--"),void this.terminal.printLine("We haven't the energy for that.");let n=t/Math.pow(this.player.warpFactor,2),a=100*n/this.game.timeRemaining;if(a>80){let e,t=/(yes|y)/i,i=/(no|n)/i;do{e=await this.terminal.ask(`First Officer Spock- "Captain, I compute that such\n  a trip would require approximately ${a.toFixed(2)}% of our\n  remaining time.  Are you sure this is wise?"`),t=/(yes|y)/i,i=/(no|n)/i}while(!t.test(e)&&!i.test(e));if(t.test(e))this.terminal.printLine("To boldly go...");else if(i.test(e))return void this.terminal.printLine("Cancelling move.")}this.player.warpTo(e),this.game.clock.elapseTime(n)}manual(e,t,i,n){try{let a=this.player.mover.calculateDestination(e,t,i,n);return this.moveTo(a)}catch(e){return void this.terminal.printLine(e.message)}}automatic(e,t,i,n){try{let a=this.galaxy.getSector(e,t,i,n);return this.moveTo(a)}catch(e){return void this.terminal.printLine(e.message)}}async run(){let e=!0,t=!1,i=re("m","manual"),n=re("a","automatic"),a=this.terminal.getArguments();if(a.some(e=>i.test(e))&&(e=!0,t=!1,a=a.filter(e=>!i.test(e))),a.some(e=>n.test(e))&&(e=!1,t=!0,a=a.filter(e=>!n.test(e))),e){if(console.log("manual mode"),2!==a.length)throw new Error("need y and x");let[e,t]=a,i=Math.trunc(e),n=Math.trunc(t),s=Math.trunc(10*e%10),r=Math.trunc(10*t%10);await this.manual(i,n,s,r)}else if(t)if(console.log("automatic mode"),4===(a=a.map(e=>Number.parseInt(e))).length)await this.automatic(a[0]-1,a[1]-1,a[2]-1,a[3]-1);else if(2===a.length){let e=this.player.gameObject.quadrant;await this.automatic(e.x,e.y,a[0]-1,a[1]-1)}}}class Te extends ue{constructor(e,t,i,n){super(),this.game=e,this.terminal=t,this.player=i,this.galaxy=n,this.abbreviation="st",this.name="status",this.regex=oe("st","status","status report"),this.fullName="status report",this.type=he,this.info='Mnemonic:  STATUS\n  Shortest abbreviation: ST\n\nThis command gives you information about the current state of your\nstarship as follows:\n\n  STARDATE - The current date. A stardate is the same as a day.\n\n  CONDITION - There are four possible conditions:\n        DOCKED - docked at starbase.\n        RED    - in battle.\n        YELLOW - low on energy (<1000 units)\n        GREEN  - none of the above\n\n  POSITION - Quadrant is given first, then sector\n\n  LIFE SUPPORT - If "ACTIVE" then life support systems are\n        functioning normally. If on "RESERVES" the number is how many\n        stardates your reserve food, air, etc. will last--you must\n        get repairs made or get to starbase before your reserves run\n        out.\n\n  WARP FACTOR - What your warp factor is currently set to.\n\n  ENERGY - The amount of energy you have left. If it drops to zero,\n        you die.\n\n  TORPEDOES - How many photon torpedoes you have left.\n\n  SHIELDS - Whether your shields are up or down, how strong they are\n       (what percentage of a hit they can deflect), and shield\n       energy.\n\n  KLINGONS LEFT - How many of the Klingons are still out there.\n\n  TIME LEFT - How long the Federation can hold out against the\n        present number of Klingons; that is, how long until the end\n        if you do nothing in the meantime.  If you kill Klingons\n        quickly, this number will go up--if not, it will go down.  If\n        it reaches zero, the federation is conquered and you lose.\n\nStatus information is free--it uses no time or energy, and if you are\nin battle, the Klingons are not given another chance to hit you.\n\nStatus information can also be obtained by doing a short-range scan.\nSee the SRSCAN command for details.\n\nEach item of information can be obtained singly by requesting it.\nSee REQUEST command for details.'}getStatusText(e=!0){if(e){this.game.clock.starDate.toFixed(1),this.player.printCondition();let e=this.player.gameObject.quadrant,t=this.player.gameObject.sector,i=this.player.collider,n=100*i.health/i.maxHealth,a=(i.health.toFixed(2),n.toFixed(1),e.x,e.y,t.x,t.y,["Life Support","NA"]);a=this.player.lifeSupport.isOk()?["Life Support","ACTIVE"]:["Life Support",`DAMAGED, reserves = ${this.player.lifeSupport.reserves.toFixed(1)}`];let s=["Warp Factor",`${this.player.warpFactor.toFixed(1)}`],r=this.player.powerGrid,o=100*r.energy/r.capacity,h=["Energy",`${r.energy.toFixed(2)}, ${o.toFixed(1)}%`],l=["Torpedoes",`${this.player.photons.getTorpedoCount()}`],c=["Shields",`${this.player.shields.printInfo()}`],m=["Klingons Left",`${this.galaxy.container.getCountOfGameObjects(Q)}`],d=["Time Left",`${this.game.timeRemaining.toFixed(2)}`],u=[["Stardate",this.game.clock.starDate.toFixed(1)],["Condition",this.player.printCondition()],["Hull Integrity",`${i.health.toFixed(2)}, ${n.toFixed(1)}%`],["Position",`${e.x+1} - ${e.y+1}, ${t.x+1} - ${t.y+1}`],a,s,h,l,c,m,d];return this.terminal.formatGrid(u,!1,null,!0).map(e=>e.join("   "))}let t=`Stardate\t${this.game.clock.starDate.toFixed(1)}`,i=`Condition\t${this.player.printCondition()}`,n=this.player.gameObject.quadrant,a=this.player.gameObject.sector,s=this.player.collider,r=100*s.health/s.maxHealth,o=`Hull Integrity\t${s.health.toFixed(2)}, ${r.toFixed(1)}%`,h=`Position\t${n.x+1} - ${n.y+1}, ${a.x+1} - ${a.y+1}`,l="Life Support NA";l=this.player.lifeSupport.isOk()?"Life Support\tACTIVE":`Life Support\tDAMAGED, reserves = ${this.player.lifeSupport.reserves.toFixed(1)}`;let c=`Warp Factor\t${this.player.warpFactor.toFixed(1)}`,m=this.player.powerGrid,d=100*m.energy/m.capacity;return[t,i,h,l,c,`Energy\t\t${m.energy.toFixed(2)}, ${d.toFixed(1)}%`,o,`Torpedoes\t${this.player.photons.getTorpedoCount()}`,`Shields\t\t${this.player.shields.printInfo()}`,`Klingons Left\t${this.galaxy.container.getCountOfGameObjects(Q)}`,`Time Left\t${this.game.timeRemaining.toFixed(2)}`]}run(){this.terminal.newLine(),this.terminal.echo(this.getStatusText().join("\n"))}}class Ce extends ue{constructor(e,t,i){super(),this.terminal=t,this.game=e,this.statusCommand=i,this.name="request",this.abbreviation="req",this.regex=oe("req","request","request information"),this.fullName="request information",this.arguments=1,this.type=he,this.info="Mnemonic:  REQUEST\n  Shortest abbreviation:  REQ\n  Full command:  REQUEST [ITEM]\n\nThis command allows you to get any single piece of information from\nthe [STATUS] command.  [ITEM] specifies which information as follows:\n\n INFORMATION       MNEMONIC FOR [ITEM]           SHORTEST ABBREVIATION\n\n STARDATE              DATE                                D\n CONDITION             CONDITION                           C\n POSITION              POSITION                            P\n LIFE SUPPORT          LSUPPORT                            L\n WARP FACTOR           WARPFACTOR                          W\n ENERGY                ENERGY                              E\n TORPEDOES             TORPEDOES                           T\n SHIELDS               SHIELDS                             S\n KLINGONS LEFT         KLINGONS                            K\n TIME LEFT             TIME                                TI"}async run(){let e=this.terminal.getArguments()[0];e||(e=await this.terminal.ask("Information desired? "));let t,i=this.statusCommand.getStatusText(),n=re("date","d"),a=re("condition","c"),s=re("position","p"),r=re("lsupport","l"),o=re("warpfactor","w"),h=re("energy","e"),l=re("hull","health","h"),c=re("torpedoes","t"),m=re("shields","s"),d=re("klingons","s"),u=re("time","ti");t=n.test(e)?i[0]:a.test(e)?i[1]:s.test(e)?i[2]:r.test(e)?i[3]:o.test(e)?i[4]:h.test(e)?i[5]:l.test(e)?i[6]:c.test(e)?i[7]:m.test(e)?i[8]:d.test(e)?i[9]:u.test(e)?i[10]:"UNRECOGNIZED REQUEST. Legal requests are:\n  date, condition, position, lsupport, warpfactor,\n  energy, torpedoes, shields, klingons, time.\n",this.terminal.echo(t)}}class Ee extends ue{constructor(e,t,i){super(),this.terminal=t,this.game=e,this.player=i,this.abbreviation="c",this.name="chart",this.regex=oe("c","chart","star chart"),this.fullName="star chart",this.type=he,this.addPadding=!1,this.info=`\n      Mnemonic:  ${this.name}\n      Shortest abbreviation:  ${this.abbreviation}\n    The chart looks like an 8 by 8 array of numbers.  These numbers are\n    interpreted exactly as they are on a long-range scan. A period (.) in\n    place of a digit means you do not know that information yet.  For\n    example, ... means you know nothing about the quadrant, while .1.\n    means you know it contains a base, but an unknown number of Klingons\n    and stars.\n\n    Looking at the star chart is a free operation.  It costs neither time\n    nor energy, and can be done safely whether in or out of battle.`}makeChartText(){let e=[];for(let t=0;t<this.game.galaxy.length;t++){let i=this.game.galaxy.getRow(t),n=[];i.forEach(e=>{let t=`${e.hasSupernova?"1":"."}${e.container.getCountOfGameObjects(Q)}${e.container.getCountOfGameObjects(ne)}${e.container.getCountOfGameObjects(ie)}`;n.push(t)}),e.push(n)}e.forEach((e,t)=>{e.unshift(`${t+1} -`),e.push("-")});let t=[" "],i=e[0].length;for(let e=1;e<i-1;e++)t.push(`  ${e} `);let n=[" "];for(let e=1;e<i-1;e++)n.push("----");return e.unshift(n),e.unshift(t),this.terminal.formatGrid(e).map(e=>e.join("  ")).join("\n")}run(){this.addPadding&&this.terminal.newLine(),this.terminal.echo("STAR CHART FOR THE KNOWN GALAXY"),this.addPadding&&this.terminal.newLine(),this.terminal.newLine(),this.terminal.printLine(this.makeChartText()),this.terminal.printLine(),this.terminal.printLine("thousands digit:   supernova\nhundreds digit:    Klingons\ntens digit:        starbases\nones digit:        stars\nperiod (.):        digit not known"),this.terminal.printLine();this.player.gameObject.quadrant;this.terminal.printLine(`Enterprise is currently in ${this.player.gameObject.getQuadrantLocation()}`),this.addPadding&&this.terminal.newLine()}}class Le extends ue{constructor(e,t,i,n,a){super(),this.terminal=t,this.game=e,this.player=i,this.chartCommand=n,this.statusCommand=a,this.abbreviation="s",this.name="srscan",this.regex=oe("s","srscan","short range scan"),this.fullName="short range scan",this.type=he,this.options={no:{abbreviation:"n",name:"no",description:"don't display status information"},chart:{abbreviation:"c",name:"no",description:"display star chart"}},this.deviceUsed=[T],this.addPadding=!1,this.info='Mnemonic:  SRSCAN\n    Shortest abbreviation:  S\n    Full commands:  SRSCAN\n                    SRSCAN NO\n                    SRSCAN CHART\n    The short-range scan gives you a considerable amount of information\n    about the quadrant your starship is in.  A short-range scan is best\n    described by an example.\n\n             1 2 3 4 5 6 7 8 9 10\n          1  * . . . . R . . . .  Stardate      2516.3\n          2  . . . E . . . . . .  Condition     RED\n          3  . . . . . * . B . .  Position      1 - 5, 4 - 2\n          4  . . . S . . . . . .  Life Support  DAMAGED, Reserves=2.30\n          5  . . . . . . . K . .  Warp Factor   5.0\n          6  . K .   . . . . * .  Energy        2176.24\n          7  . . . . . P . . . .  Torpedoes     3\n          8  . . . . * . . . . .  Shields       UP, 42% 1050.0 units\n          9  . * . . * . . . C .  Klingons Left 12\n         10  . . . . . . . . . .  Time Left     3.72\n\n\n    The left part is a picture of the quadrant.  The E at sector 4 - 2\n    represents the Enterprise; the B at sector 8 - 3 is a starbase.\n    There are ordinary Klingons (K) at sectors 8 - 5 and 2 - 6, and a\n    Klingon Commander (C) at 9 - 9.  The (GULP) "Super-commander" (S) is\n    occupies sector 4 - 4, and a Romulan (R) is at 6 - 1.  A planet (P)\n    is at sector 6 - 7.  There are also a large number of stars (*). The\n    periods (.) are just empty space--they are printed to help you get\n    your bearings.  Sector 6 - 4 contains a black hole ( ).\n\n    The information on the right is assorted status information. You can\n    get this alone with the STATUS command.  The status information will\n    be absent if you type "N" after SRSCAN.  Otherwise status information\n    will be presented.\n\n    If you type "C" after SRSCAN, you will be given a short-range scan\n    and a Star Chart.\n\n    Short-range scans are free.  That is, they use up no energy and no\n    time.  If you are in battle, doing a short-range scan does not give\n    the enemies another chance to hit you.  You can safely do a\n    short-range scan anytime you like.'}objectToText(e){return e?e instanceof Y?"K":e instanceof z?"C":e instanceof W?"S":e instanceof V?"R":e instanceof te?"E":e instanceof ie?"*":e instanceof ae?"P":e instanceof ne?"B":e instanceof se?" ":"?":"."}async run(){let e=this.player.deviceContainer.getDevice(T);if(!e)return void this.terminal.printLine("Captain we don't have sensors!");let t=re("n","no"),i=!this.terminal.hasOption(t),n=re("c","chart"),a=this.terminal.hasOption(n),s=this.player.gameObject.quadrant,r=[];if(e.isDamaged()){for(let e=0;e<s.sectors.length;e++){let t=[];s.sectors[e].forEach(e=>{t.push("-")}),r.push(t)}this.player.gameObject.sector.getAdjacentSectors(!0).forEach(e=>{let t=e.container.getAllGameObjects()[0];r[e.y][e.x]=this.objectToText(t)})}else for(let e=0;e<s.sectors.length;e++){let t=[];s.sectors[e].forEach(e=>{let i=e.container.getAllGameObjects()[0];t.push(this.objectToText(i))}),r.push(t)}r.forEach((e,t)=>{e.unshift(`${t+1}`)});let o=[" "],h=r[0].length;for(let e=1;e<h;e++)o.push(`${e}`);if(r.unshift(o),r=this.terminal.formatGrid(r),this.addPadding&&this.terminal.newLine(),this.terminal.printLine("CHART OF THE CURRENT QUADRANT"),this.terminal.newLine(),i){r=r.map(e=>e.join(" ")),this.statusCommand.getStatusText().forEach((e,t)=>{r[t]+="  "+e});let e=r.join("\n");this.terminal.echo(e)}else this.terminal.printGrid(this.terminal.formatGrid(r)," ","",!0);a&&(this.terminal.echo("\n\n"),this.terminal.echo(this.chartCommand.makeChartText())),this.addPadding&&this.terminal.newLine(),this.terminal.newLine(),this.terminal.printLine("E = Enterprise"),this.terminal.printLine("K = klingon; C = commander; S = super commander; R = romulan;"),this.terminal.printLine(". = nothing; * = star; empty = black hole."),this.terminal.printLine("p = planet; b = base;"),this.addPadding&&this.terminal.newLine()}}class je extends ue{constructor(e,t,i){super(),this.terminal=t,this.game=e,this.player=i,this.abbreviation="l",this.name="lrscan",this.regex=oe("l","lrscan","long range scan"),this.fullName="Long Range Scan",this.type=he,this.info='  Mnemonic:  LRSCAN\n      Shortest abbreviation:  L\n\n    A long-range scan gives you general information about where you are\n    and what is around you.  Here is an example output.\n\n        Long-range scan for Quadrant 5 - 1\n           -1  107  103\n           -1  316    5\n           -1  105 1000\n\n    This scan says that you are in row 5, column 1 of the 8 by 8 galaxy.\n    The numbers in the scan indicate how many of each kind of thing there\n    is in your quadrant and all adjacent quadrants.  The digits are\n    interpreted as follows.\n\n        Thousands digit:  1000 indicates a supernova (only)\n        Hundreds digit:   number of Klingons present\n        Tens digit:       number of starbases present\n        Ones digit:       number of stars present\n\n    For example, in your quadrant (5 - 1) the number is 316, which\n    indicates 3 Klingons, 1 starbase, and 6 stars.  The long-range\n    scanner does not distinguish between ordinary Klingons and Klingon\n    command ships.  If there is a supernova, as in the quadrant below and\n    to your right (quadrant 6 - 2), there is nothing else in the\n    quadrant.\n\n    Romulans possess a "cloaking device" which prevents their detection\n    by long-range scan.  Because of this fact, Starfleet Command is never\n    sure how many Romulans are "out there".  When you kill the last\n    Klingon, the remaining Romulans surrender to the Federation.\n\n    Planets are also undetectable by long-range scan.  The only way to\n    detect a planet is to find it in your current quadrant with the\n    short-range sensors.\n\n    Since you are in column 1, there are no quadrants to your left. The\n    minus ones indicate the negative energy barrier at the edge of the\n    galaxy, which you are not permitted to cross.\n\n    Long-range scans are free.  They use up no energy or time, and can be\n    done safely regardless of battle conditions.'}run(){let e=this.game.player.gameObject.quadrant,t=[];for(let i=e.y-1;i<=e.y+1;i++){let n=[];for(let t=e.x-1;t<=e.x+1;t++){let e=null;try{if(e=this.game.galaxy.getQuadrant(t,i)){let t=0,i=e.hasSupernova?"1":" ",a=e.container.getCountOfGameObjects(Q);t+=100*a,a=0===a?" ":a;let s=e.container.getCountOfGameObjects(ne);s=0===s?" ":s;let r=e.container.getCountOfGameObjects(ie),o=`${i}${a}${s}${r=0===r?" ":r}`;n.push(o)}else n.push("-1")}catch(e){n.push("-1")}}t.push(n)}this.terminal.echo(`\nLong-range scan for ${this.player.gameObject.getQuadrantLocation()}\n\n`);let i=this.terminal.formatGrid(t).map(e=>e.join("\t")).join("\n");this.terminal.echo(i),this.terminal.newLine()}}class Me extends ue{constructor(e,t,i){super(),this.game=e,this.terminal=t,this.player=i,this.abbreviation="d",this.name="dock",this.fullName="dock at starbase",this.regex=oe(this.abbreviation,this.name,this.fullName),this.deviceUsed="",this.options={},this.type=he,this.info="\n  Mnemonic:  DOCK\n  Shortest abbreviation:  D\n\nYou may dock your starship whenever you are in one of the eight\nsector positions immediately adjacent to a starbase.  When you dock,\nyour starship is resupplied with energy, shield energy photon\ntorpedoes."}run(){if(this.player.docked)return void this.terminal.echo("Already docked.");let e=this.player.gameObject.sector,t=this.player.gameObject.quadrant,i=!1;for(let n=e.x-1;n<=e.x+1;n++){for(let a=e.y-1;a<=e.y+1;a++)try{let e=t.getSector(n,a).container.getGameObjectsOfType(ne)[0];if(e){i=!0,this.player.dock(e),this.terminal.echo("Docked.");break}}catch(e){}if(i)break}i||this.terminal.echo(`${this.player.name} is not adjacent to a starbase.`)}}const $e=1,Re=2,De=4,Ne=1,Ae=2,_e=3,Pe=4,Ie=5,Ge=1,qe=2,Fe=3,He=!0;class Ke{constructor(e,t,i,n,a){this.terminal=e,this.pane1=t,this.pane2=i,this.screen=n,this.screen.addSizeChangeCallback(this.onScreenSizeChange.bind(this)),this.hideInfoPanes(),this.service=new r,this.shipBuilder=new B,this.galaxy=new v(8,8,10,10,!0),this.commands=[],this.length=De,this.clock=x,this.clock.init(100*(31*Math.random()+20)),this.onElapseTime=this.onElapseTime.bind(this),this.clock.register(this.onElapseTime),this.timeRemaining=7,this.skill=_e,this.secretPassword=null,this.player=new te(this.terminal,this.clock);{let e=this.galaxy.getRandomQuadrant(),t=e.getRandomSector();this.player.gameObject.placeIn(this.galaxy,e,t)}this.setDifficulty(this.skill),this.resolveUserCommand=null,this.initialEnemies=null,this.initialKlingons=null,this.initialCommanders=null,this.initialSuperCommands=null,this.initialRomulans=null,this.fallenFoes=[],this.federationPowerRemaining=null}setDifficulty(e){switch(e){case Ne:this.player.phasers.overheatThreshold=1500,this.shipBuilder.kHealth=40,this.shipBuilder.kEnergy=400,this.shipBuilder.kcHealth=100,this.shipBuilder.kcEnergy=1200,this.shipBuilder.kscHealth=400,this.shipBuilder.kscEnergy=1750,this.shipBuilder.rHealth=40,this.shipBuilder.rEnergy=700,p.setDeviceDamageRange(100,275);break;case Ae:this.player.phasers.overheatThreshold=1500,this.shipBuilder.kHealth=40,this.shipBuilder.kEnergy=400,this.shipBuilder.kcHealth=100,this.shipBuilder.kcEnergy=1200,this.shipBuilder.kscHealth=400,this.shipBuilder.kscEnergy=1750,this.shipBuilder.rHealth=40,this.shipBuilder.rEnergy=700,p.setDeviceDamageRange(80,275);break;case _e:this.player.phasers.overheatThreshold=1200,this.shipBuilder.kHealth=100,this.shipBuilder.kEnergy=700,this.shipBuilder.kcHealth=200,this.shipBuilder.kcEnergy=1500,this.shipBuilder.kscHealth=600,this.shipBuilder.kscEnergy=2500,this.shipBuilder.rHealth=100,this.shipBuilder.rEnergy=700,p.setDeviceDamageRange(50,250);break;case Pe:this.player.phasers.overheatThreshold=1e3,this.shipBuilder.kHealth=100,this.shipBuilder.kEnergy=700,this.shipBuilder.kcHealth=200,this.shipBuilder.kcEnergy=1500,this.shipBuilder.kscHealth=600,this.shipBuilder.kscEnergy=2500,this.shipBuilder.rHealth=100,this.shipBuilder.rEnergy=700,p.setDeviceDamageRange(50,200);break;case Ie:this.player.phasers.overheatThreshold=800,this.shipBuilder.kHealth=100,this.shipBuilder.kEnergy=700,this.shipBuilder.kcHealth=200,this.shipBuilder.kcEnergy=1500,this.shipBuilder.kscHealth=600,this.shipBuilder.kscEnergy=2500,this.shipBuilder.rHealth=100,this.shipBuilder.rEnergy=700,p.setDeviceDamageRange(50,200);break;default:return void console.error("invalid skill setting.",e)}this.skill=e}calculateKlingonStrength(){return this.galaxy.container.getCountOfGameObjects(Y)+4*this.galaxy.container.getCountOfGameObjects(z)+10*this.galaxy.container.getCountOfGameObjects(W)}decrementFederationPower(e){this.federationPowerRemaining-=e*this.calculateKlingonStrength()}recalculateTimeRemaining(){this.timeRemaining=this.federationPowerRemaining/this.calculateKlingonStrength()}onElapseTime(e){this.decrementFederationPower(e),this.recalculateTimeRemaining()}calculateScore(){let e=this.getNumberOfTypeKilled(Q),t=10*this.getNumberOfTypeKilled(Y)+50*this.getNumberOfTypeKilled(z)+200*this.getNumberOfTypeKilled(W);t+=20*this.getNumberOfTypeKilled(V);let i=this.clock.getElapsedTime();return 0===i&&(i=1),t+=500*(e/i),this.isVictory()&&(t+=100*this.skill),this.player.isDead()&&(t-=200),t}getGameLengthStr(){switch(this.length){case $e:return"short";case Re:return"medium";case De:return"long";default:console.error("unknown game length")}}getDifficultyStr(){switch(this.skill){case Ne:return"novice";case Ae:return"fair";case _e:return"good";case Pe:return"expert";case Ie:return"emeritus";default:console.error("unknown difficulty")}}killEnemy(e){this.fallenFoes.push(e)}getNumberOfTypeKilled(e){return this.fallenFoes.reduce((t,i)=>(i instanceof e&&t++,t),0)}async onScreenSizeChange(){this.screen.isSmallScreen||this.screen.isTinyScreen?(this.terminal.registerCommand(this.scanCommand),this.terminal.registerCommand(this.chartCommand)):this.screen.isMediumScreen?(this.terminal.registerCommand(this.chartCommand),this.terminal.unregisterCommand(this.scanCommand)):this.screen.isLargeScreen&&(this.terminal.unregisterCommand(this.scanCommand),this.terminal.unregisterCommand(this.chartCommand)),await this.render()}async render(){this.screen.isSmallScreen||(this.screen.isMediumScreen?await this.renderPane1():this.screen.isLargeScreen&&(await this.renderPane1(),await this.renderPane2()))}hideInfoPanes(){this.pane1.$el.hide(),this.pane2.$el.hide()}showInfoPanes(){this.screen.isSmallScreen||(this.screen.isMediumScreen?this.pane1.$el.show():this.screen.isLargeScreen&&(this.pane1.$el.show(),this.pane2.$el.show()))}async renderPane1(){this.pane1.clearAll(),await this.pane1Command.run(),this.pane1.print()}async renderPane2(){this.pane2.clearAll(),await this.pane2Command.run(),this.pane2.print()}setup(){this.makeCommands(),this.makeStars(),this.makePlanets(),this.makeBases(),this.makeBlackHoles(),this.makeEnemies(),this.timeRemaining=7*this.length,this.federationPowerRemaining=this.calculateKlingonStrength()*this.timeRemaining,this.registerCommands(),this.showInfoPanes(),this.onScreenSizeChange(),this.loop()}start(){this.setup();let e=this.galaxy.container.getGameObjectsOfType(ne),t=e.map(e=>[e.gameObject.quadrant.x+1,e.gameObject.quadrant.y+1].join(" - ")).join("   "),i=`It is stardate ${this.clock.starDate.toFixed(0)}. Federation is being attacked by\na deadly Klingon invasion force. As captain of the UnitedStarship U.S.S. Enterprise, it is your mission to seek out and destroy this invasion force of ${this.numberOfKlingons} klingons.\n\nThe Klingons will overpower the Federation in ${this.timeRemaining} days, every Klingon you destroy will weaken this invasion force and buy us more time.\n\nYou will have ${e.length} supporting starbases.\nStarbase locations-   ${t}\n\nThe Enterprise is currently in ${this.player.gameObject.getLocation()}\n\nTRY TYPING "COMMANDS"\n\nGood Luck!\n`;this.terminal.$terminal.echo(i)}isInCombat(){return this.player.gameObject.quadrant.container.getCountOfGameObjects(U)>0}async loop(){let e=!1;for(;!this.isDefeat()&&!this.isVictory();){let t=!0,i=!1,n=!1,a=!1;for(;t&&!this.isVictory()&&!this.isDefeat();){await this.render();let{command:s}=await this.terminal.runUserCommand();await s.run(),this.terminal.print(),s.isInfoCommand()||s.isInstantShipCommand()||(this.recalculateTimeRemaining(),n=(a=this.isInCombat())&&!e,a?s.isMoveCommand()?(!i&&e||(t=!1),i=!0):t=(s.isAttackCommand(),!1):i=!1)}if(this.isVictory()||this.isDefeat())break;a&&!n&&this.player.gameObject.quadrant.container.getGameObjectsOfType(U).forEach(e=>{e.ai.takeTurn()}),e=a,this.terminal.print(),this.recalculateTimeRemaining()}let t=this.isVictory(),i=this.isDefeat(),n=this.calculateScore();this.service.createGameLog(n,t),this.terminal.skipLine(2),t?(this.terminal.printLine("You win!"),this.terminal.printLine(`It is stardate ${this.clock.starDate.toFixed(1)}.`),this.terminal.print()):i&&(this.terminal.printLine("You lose..."),this.terminal.printLine(`It is stardate ${this.clock.starDate.toFixed(1)}.`),this.timeRemaining<=0?this.terminal.printLine("Your time has run out and the Federation has been conquered.\nWith your starship confiscated by the Klingon High Command, you relocate to a mining facility and learn to love gagh."):this.player.isDead()&&(this.terminal.printLine("The Enterprise has been destroyed in battle."),this.terminal.skipLine(),this.terminal.printLine("Dulce et decorum est pro patria mori.\nThe Federation will be destroyed."),this.terminal.skipLine()),this.terminal.print()),this.terminal.silent=!1,new fe(this,this.terminal,this.player).run({}),this.terminal.print()}isDefeat(){return this.player.isDead()||this.timeRemaining<=0}isVictory(){return 0===this.galaxy.container.getCountOfGameObjects(Q)}makeCommands(){this.commands=[],this.chartCommand=new Ee(this,this.terminal,this.player);let e=new Oe(this,this.terminal),t=new Te(this,this.terminal,this.player,this.galaxy);this.commands.push(new Se(this,this.terminal,this.player)),this.commands.push(e),this.commands.push(t),this.commands.push(new Ce(this,this.terminal,t)),this.commands.push(this.chartCommand),this.scanCommand=new Le(this,this.terminal,this.player,this.chartCommand,t),this.commands.push(this.scanCommand),Qe&&this.commands.push(new je(this,this.terminal,this.player)),this.commands.push(new xe(this,this.terminal,e)),this.commands.push(new ke(this,this.terminal,this.player,this.galaxy)),this.commands.push(new ve(this,this.terminal,this.player)),this.commands.push(new Me(this,this.terminal,this.player)),this.commands.push(new we(this,this.terminal,this.player)),this.commands.push(new be(this,this.terminal,this.galaxy,this.player)),this.commands.push(new fe(this,this.terminal,this.player)),this.commands.push(new ge(this.terminal,this.player)),this.commands.push(new ye(this,this.terminal,this.player)),this.commands.push(new pe(this,this.terminal));let i=new Te(this,this.pane1,this.player,this.galaxy),n=new Ee(this,this.pane2,this.player);this.pane1Command=new Le(this,this.pane1,this.player,n,i),this.pane2Command=n}registerCommands(){this.commands.forEach(e=>{this.terminal.registerCommand(e)})}makeBlackHoles(){this.galaxy.quadrants.forEach(e=>{e.forEach(e=>{for(let t=0;t<3;t++){let t=e.getRandomEmptySector();(new se).gameObject.placeIn(this.galaxy,e,t)}})})}makeStars(){this.galaxy.quadrants.forEach((e,t)=>{e.forEach((e,t)=>{let i=Math.round(8*Math.random()+1);for(let t=0;t<i;t++){let t=new ie,i=e.getRandomEmptySector();i.container.isEmpty(),t.gameObject.placeIn(this.galaxy,i.quadrant,i)}})})}makePlanets(){let e=Math.round(5+10/3*Math.random());console.log(`number of planets = ${e}`);for(let t=0;t<e;t++){let e;do{e=this.galaxy.getRandomQuadrant()}while(e.container.getCountOfGameObjects(ae)>0);let t=e.getRandomEmptySector(),i=new ae;i.randomlyGenerate(),i.gameObject.placeIn(this.galaxy,e,t),console.log(`planet at ${i.gameObject.getLocation()}`)}}makeBases(){let e=Math.round(3*Math.random()+2),t=[];for(;t.length<e;){let i=this.galaxy.getRandomQuadrant();if(0===i.container.getCountOfGameObjects(ne)){let n=!1;for(let a=0;a<t.length;a++){let s=t[a].gameObject.quadrant,r=i.x-s.x,o=i.y-s.y;if(r*r+o*o<6*(6-e)&&Math.random()<.75){n=!0;break}}if(!n){console.log("making starbase");let e=new ne,n=i.getRandomEmptySector();e.gameObject.placeIn(this.galaxy,i,n),t.push(e)}}}}makeEnemies(){let e=Math.round(14*this.length*((this.skill+1-2*Math.random())*this.skill*.1+.15));console.log(`number of enemies = ${e}`);let t=Math.round(this.skill+.0625*e*Math.random());t=Math.min(10,t);let i=this.skill>Ae?1:0,n=e-t-i;this.numberOfKlingons=n;let a=Math.round(2*Math.random()*this.skill);this.initialEnemies=e,this.initialKlingons=n,this.initialCommanders=t,this.initialSuperCommands=i,this.initialRomulans=a,this.makeKlingons(n),this.makeKlingonCommanders(t),this.makeKlingonSuperCommanders(i),this.makeRomulans(a)}makeKlingonSuperCommanders(e){for(let t=0;t<e;t++){let e;if(this.skill>=_e)do{e=this.galaxy.getRandomQuadrant()}while(0===e.container.getCountOfGameObjects(Q)||this.player.gameObject.quadrant===e);else if(this.skill>=Ae)do{e=this.galaxy.getRandomQuadrant()}while(this.player.gameObject.quadrant===e);else do{e=this.galaxy.getRandomQuadrant()}while(e.container.getCountOfGameObjects(Q)>0||this.player.gameObject.quadrant===e);console.log("placing super commander");let t=e.getRandomEmptySector();this.shipBuilder.makeKlingonSuperCommander(this.galaxy,this.player,this,e,t)}}makeKlingonCommanders(e){for(let t=0;t<e;t++){let e;if(this.skill>=_e)do{e=this.galaxy.getRandomQuadrant()}while(0===e.container.getCountOfGameObjects(Q)||this.player.gameObject.quadrant===e);else if(this.skill>=Ae)do{e=this.galaxy.getRandomQuadrant()}while(this.player.gameObject.quadrant===e);else do{e=this.galaxy.getRandomQuadrant()}while(e.container.getCountOfGameObjects(Q)>0||this.player.gameObject.quadrant===e);console.log("placing commander");let t=e.getRandomEmptySector();this.shipBuilder.makeKlingonCommander(this.galaxy,this.player,this,e,t)}}makeKlingons(e){let t=Math.min(.25*this.skill*(9-this.length)+1,9),i=this.galaxy.quadrants.flat();for(i=i.filter(e=>e!==this.player.gameObject.quadrant);e>0;){let n=Math.round(Math.random()*(i.length-1)),a=i.splice(n,1)[0];if(!a)break;let s=Math.random(),r=Math.round((1-s*s)*t);r=Math.min(r,e);for(let t=0;t<r&&!a.isFull();t++){let t=a.getRandomEmptySector();console.log("placing klingon"),this.shipBuilder.makeKlingon(this.galaxy,this.player,this,a,t),e--}}}makeRomulans(e){for(let t=0;t<e;t++){let e;do{e=this.galaxy.getRandomQuadrant()}while(this.player.gameObject.quadrant===e);let t=e.getRandomEmptySector();console.log("placing romulan"),this.shipBuilder.makeRomulan(this.galaxy,this.player,this,e,t)}}}class Be{constructor(e){this.mode=null,this.length=null,this.difficulty=null,this.secretPassword=null,this.tournamentNumber=null,this.terminal=e,this.startGamePs="COMMAND>",this.game=null}skipLine(e){var t="";for(let i=0;i<e;i++)t+="\n";this.terminal.$terminal.echo(t)}start(){this.mode=null,this.length=null,this.difficulty=null,this.secretPassword=null,this.skipLine(2),this.terminal.$terminal.echo(`Latest update- ${Ye}.`),this.skipLine(1),this.ask("Would you like a regular, tournament, or frozen game?",["regular","tournament","frozen"],this.chooseMode.bind(this))}chooseMode(e){e=e.toLowerCase(),/regular/.test(e)?(this.mode=Ge,this.skipLine(1),this.ask("Would you like a Short, Medium, or Long game? ",["short","medium","long"],this.chooseLength.bind(this))):/tournament/.test(e)?(this.mode=qe,this.terminal.$terminal.echo("Sorry that's not implemented."),this.start()):/frozen/.test(e)&&(this.mode=Fe,this.terminal.$terminal.echo("Sorry that's not implemented."),this.start())}chooseLength(e){e=e.toLowerCase(),/short/.test(e)?this.length=$e:/medium/.test(e)?this.length=Re:/long/.test(e)&&(this.length=De),this.ask("Are you a Novice, Fair, Good, Expert, or Emeritus player? ",["novice","fair","good","expert","emeritus"],this.chooseDifficulty.bind(this))}chooseDifficulty(e){e=e.toLowerCase(),/novice/.test(e)?this.difficulty=Ne:/fair/.test(e)?this.difficulty=Ae:/good/.test(e)?this.difficulty=_e:/expert/.test(e)?this.difficulty=Pe:/emeritus/.test(e)&&(this.difficulty=Ie),this.prompt("Please type in a secret password (9 characters maximum)-",this.chooseSecretPassword.bind(this),this.startGamePs)}chooseSecretPassword(e){this.secretPassword=e,this.finish()}finish(){this.terminal.$terminal.change_settings({ps:this.startGamePs}),this.game.setDifficulty(this.difficulty),this.game.length=this.length,this.game.secretPassword=this.secretPassword,this.game.start()}prompt(e,t,i){this.terminal.$terminal.echo(e),this.terminal.$terminal.register("command",{name:"ask",method:e=>{let n=this.terminal.$terminal.get_input();if(this.terminal.$terminal.unregister("command","ask"),setTimeout(()=>t(n),10),i)return{ps:i}},regex:new RegExp("[sS]*","i")})}ask(e,t,i){this.terminal.$terminal.echo(e),this.terminal.$terminal.register("command",{name:"ask",method:e=>{let t=this.terminal.$terminal.get_input();this.terminal.$terminal.unregister("command","ask"),setTimeout(()=>i(t),10)},regex:new RegExp(`(${t.join("|")})`,"i")})}}class Ue{constructor(){this.isTinyScreen=!1,this.isSmallScreen=!1,this.isMediumScreen=!0,this.isLargeScreen=!1,this.receivedNotificationCount=0,matchMedia?(this._isTinyScreenQuery=matchMedia("(max-width: 767px)"),this._isSmallScreenQuery=matchMedia("(min-width: 768px) and (max-width: 991px)"),this._isMediumScreenQuery=matchMedia("(min-width: 992px) and (max-width: 1299px)"),this._isLargeScreenQuery=matchMedia("(min-width: 1300px)"),this.handleSizeChange=this.handleSizeChange.bind(this),this._isTinyScreenQuery.addEventListener?(this._isTinyScreenQuery.addEventListener("change",this.handleSizeChange),this._isSmallScreenQuery.addEventListener("change",this.handleSizeChange),this._isMediumScreenQuery.addEventListener("change",this.handleSizeChange),this._isLargeScreenQuery.addEventListener("change",this.handleSizeChange)):this._isTinyScreenQuery.addListener?(console.error("mediaQuery.addEventListener not supported, using addListener"),this._isTinyScreenQuery.addListener(this.handleSizeChange),this._isSmallScreenQuery.addListener(this.handleSizeChange),this._isMediumScreenQuery.addListener(this.handleSizeChange),this._isLargeScreenQuery.addListener(this.handleSizeChange)):(setInterval(this.pollForSizeChange.bind(this),1e3),console.error("matchMedia.addListener not supported, resorting to polling every second")),this.determineScreenSize(),this.onSizeChangeCallbacks=[]):console.error("match media not supported....abandon ship")}pollForSizeChange(){let e=this.isTinyScreen,t=this.isSmallScreen,i=this.isMediumScreen,n=this.isLargeScreen;this.determineScreenSize(),e===this.isTinyScreen&&t===this.isSmallScreen&&i===this.isMediumScreen&&n===this.isLargeScreen||this.onSizeChangeCallbacks.forEach(e=>e(this))}handleSizeChange(){this.receivedNotificationCount++,2===this.receivedNotificationCount&&(this.receivedNotificationCount=0,this.determineScreenSize(),this.onSizeChangeCallbacks.forEach(e=>e(this)))}determineScreenSize(){this.isTinyScreen=this._isTinyScreenQuery.matches,this.isSmallScreen=this._isSmallScreenQuery.matches,this.isMediumScreen=this._isMediumScreenQuery.matches,this.isLargeScreen=this._isLargeScreenQuery.matches}addSizeChangeCallback(e){this.onSizeChangeCallbacks.push(e)}}i.d(t,"DEBUG",(function(){return Qe})),i.d(t,"LAST_UPDATED_AT",(function(){return Ye})),new n.a("error").init();const Qe=!1,Ye="Oct 27 2019";$(document).ready((function(){(new a.a).init(),window.screen=new Ue;h.init($("#main-pane"),"boring"),l.init($("#info-pane-1")),c.init($("#info-pane-2"));let e=new Ke(h,l,c,screen),t=new Be(h);t.game=e,h.silent=!1,Qe?(h.setPrompt("COMMAND>"),e.start(),window.game=e,window.terminal=h):t.start()}))}]);